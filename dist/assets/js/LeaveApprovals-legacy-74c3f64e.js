System.register(["./index-legacy-539dcb9c.js","./react-vendor-legacy-4587369d.js","./usePullToRefresh-legacy-9e1aa060.js"],function(e,t){"use strict";var r,s,a,o,n,d,i,l,c;return{setters:[e=>{r=e.j,s=e.u,a=e.b,o=e.a,n=e.g,d=e._},e=>{i=e.N,l=e.r},e=>{c=e.u}],execute:function(){e("default",function(){const e=localStorage.getItem("auth"),p=e?JSON.parse(e):null;if(!p||"hod"!==p.role)return r(i,{to:"/home",replace:!0});const{showSuccess:u,showError:h}=s(),[v,m]=l.useState([]),[g,f]=l.useState(!1),[w,y]=l.useState(null),x=async()=>{try{f(!0);const e=new URLSearchParams({department:p.department,type:"leave",status:"requested"});console.log("[LeaveApprovals] Fetching with:",{department:p.department,type:"leave",status:"requested"});const t=await o.get(`/api/leaves?${e.toString()}`);return console.log("[LeaveApprovals] Response:",t),t.success?(m(t.requests||[]),y({filter:t.filter,count:t.requests?.length||0,hodDept:p.department}),t):(h("Failed to load",t.error||"Could not fetch requests"),t)}catch(e){console.error("[LeaveApprovals] Error:",e),h("Error",n(e,"Could not load leave requests."))}finally{f(!1)}};l.useEffect(()=>{x()},[]),c(x),l.useEffect(()=>{const e=()=>x();return window.addEventListener("notificationsUpdated",e),window.addEventListener("marksheetsUpdated",e),()=>{window.removeEventListener("notificationsUpdated",e),window.removeEventListener("marksheetsUpdated",e)}},[]);const b=async(e,r)=>{try{const n="approve"===r?{timeout:12e4}:{},i=await o.patch(`/api/leaves?id=${e}&action=${r}`,{hodId:p.id},Object.assign({},n,{dispatch:!1}));if(i&&i.success){if("approve"===r&&i.whatsappResult){const e=i.whatsappResult;e.sentPdf?u("Approved & Sent","Leave letter PDF sent via WhatsApp"):e.sentText?(u("Approved (text sent)","Approval text sent but PDF failed to send"),e.errors&&e.errors.length&&h("PDF send failed",e.errors[0])):(u("Approved","Request approved"),e.errors&&e.errors.length&&h("WhatsApp failed",e.errors[0]))}else u("approve"===r?"Approved":"Rejected","Request updated");try{d(()=>t.import("./notificationEvents-legacy-ed9f7877.js"),void 0).then(e=>e.notifyNotificationsUpdated())}catch(s){try{window.dispatchEvent(new Event("notificationsUpdated"))}catch(a){}}try{window.refreshNotificationCount&&window.refreshNotificationCount()}catch(s){}x()}else h("Failed",i?.error||"Could not update request")}catch(i){if(i&&("AbortError"===i.name||String(i).includes("signal is aborted")||String(i).includes("timeout")))try{const t=await x();t&&t.requests&&t.requests.find(t=>t._id===e)?h("Timeout","Server took too long to respond. The approval may not have completed — check request status."):u("Approved","Request approved (server-side) — refreshed list updated")}catch(l){h("Timeout","Server took too long to respond. The approval may have completed — check request status.")}else h("Error",n(i,"Could not process approval. Please try again."))}};return a("div",{className:"px-4 py-4 w-full max-w-4xl mx-auto",children:[a("div",{className:"flex items-center justify-between mb-4",children:[r("h1",{className:"text-2xl font-bold",children:"Leave Approvals"}),r("button",{onClick:x,className:"px-3 py-2 text-sm rounded-lg border bg-white hover:bg-gray-50",disabled:g,children:g?"Loading...":"Refresh"})]}),w&&a("div",{className:"mb-4 p-3 bg-blue-50 rounded-lg text-xs",children:[a("div",{children:["HOD Dept: ",w.hodDept]}),a("div",{children:["Found: ",w.count," requests"]})]}),g?r("div",{className:"p-4 text-gray-500",children:"Loading..."}):a("ul",{className:"divide-y bg-white rounded-xl shadow",children:[v.map(e=>a("li",{className:"p-4 flex items-center justify-between",children:[a("div",{children:[a("div",{className:"font-medium",children:[e.studentDetails?.name," (",e.studentDetails?.regNumber,")"]}),a("div",{className:"text-sm text-gray-600",children:[new Date(e.startDate).toLocaleDateString()," → ",new Date(e.endDate).toLocaleDateString()]}),a("div",{className:"text-sm text-gray-600",children:["Reason: ",e.reason]})]}),a("div",{className:"flex gap-2",children:[r("button",{onClick:()=>b(e._id,"approve"),className:"px-3 py-2 text-sm rounded-lg bg-green-600 text-white",children:"Approve"}),r("button",{onClick:()=>b(e._id,"reject"),className:"px-3 py-2 text-sm rounded-lg bg-red-600 text-white",children:"Reject"})]})]},e._id)),0===v.length&&r("li",{className:"p-4 text-gray-500",children:"No pending requests."})]})]})})}}});
