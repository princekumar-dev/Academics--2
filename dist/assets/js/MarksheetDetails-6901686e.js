import{j as e,b as s,F as S,u as V,a as D}from"./index-35ab9bf4.js";import{f as L,u as B,r as c}from"./react-vendor-ad4d5528.js";import{d as H,a as P}from"./resultUtils-190b400a.js";function Q(){var R,_,j,C,I,M,E,F,A,O;const{id:l}=L(),N=B(),[t,h]=c.useState(null),[v,f]=c.useState(!0),[p,i]=c.useState(""),[u,w]=c.useState(!1),[y,b]=c.useState({studentDetails:{},subjects:[]}),[n]=c.useState(()=>{try{const r=localStorage.getItem("auth");return r?JSON.parse(r):null}catch(r){return null}});c.useEffect(()=>{(async()=>{if(!l||l==="undefined"||l==="null"){i("Invalid marksheet id"),f(!1);return}try{const a=await D.get("/api/marksheets?marksheetId=".concat(encodeURIComponent(l)));!a||!a.success||!a.marksheet?i((a==null?void 0:a.error)||"Failed to load marksheet"):(h(a.marksheet),a.marksheet&&b({studentDetails:{...a.marksheet.studentDetails||{}},subjects:Array.isArray(a.marksheet.subjects)?a.marksheet.subjects.map(d=>{const g=P(d);return{...d,result:g==="—"?"Pass":g}}):[]}))}catch(a){i(a.message||"Unexpected error")}finally{f(!1)}})()},[l]);const m=c.useMemo(()=>{const r=(t==null?void 0:t.status)==="rescheduled_by_hod"?"dispatch_requested":(t==null?void 0:t.status)||"unknown",a={draft:{label:"Draft",className:"bg-gray-100 text-gray-800"},verified_by_staff:{label:"Verified by Staff",className:"bg-green-100 text-green-800"},dispatch_requested:{label:"Dispatch Requested",className:"bg-yellow-100 text-yellow-800"},approved_by_hod:{label:"Approved by HOD",className:"bg-blue-100 text-blue-800"},rejected_by_hod:{label:"Rejected by HOD",className:"bg-red-100 text-red-800"},dispatched:{label:"Dispatched",className:"bg-purple-100 text-purple-800"},unknown:{label:"Unknown",className:"bg-gray-200 text-gray-700"}};return a[r]||a.unknown},[t]),o=c.useMemo(()=>{var d;if(!t||!n||n.role!=="staff")return!1;const r=((d=t.staffId)==null?void 0:d._id)||t.staffId,a=n._id||n.id;if(!r||!a)return!1;try{return String(r)===String(a)}catch(g){return!1}},[t,n]),$=c.useMemo(()=>{var d;if(!t||!n||n.role!=="hod")return!1;const r=((d=t.hodId)==null?void 0:d._id)||t.hodId,a=n._id||n.id;if(!r||!a)return!1;try{return String(r)===String(a)}catch(g){return!1}},[t,n]),k=(n==null?void 0:n.role)==="staff"&&o,q=c.useMemo(()=>H(t),[t]);return v?e("div",{className:"min-h-screen bg-gradient-to-br from-slate-50 via-blue-50 to-indigo-50 flex items-center justify-center",children:s("div",{className:"glass-card p-8 rounded-3xl text-center",children:[e("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto mb-4"}),e("p",{className:"text-gray-600",children:"Loading marksheet..."})]})}):p||!t?e("div",{className:"min-h-screen bg-gradient-to-br from-slate-50 via-blue-50 to-indigo-50 flex items-center justify-center",children:s("div",{className:"glass-card p-8 rounded-3xl text-center",children:[e("h1",{className:"text-2xl font-bold text-gray-900 mb-4",children:"Not Found"}),e("p",{className:"text-gray-600",children:p||"Marksheet not found"}),e("button",{onClick:()=>N(-1),className:"mt-6 px-5 py-2 bg-blue-600 text-white rounded-lg",children:"Go Back"})]})}):e("div",{className:"min-h-screen bg-gradient-to-br from-slate-50 via-blue-50 to-indigo-50",children:e("div",{className:"container mx-auto px-4 sm:px-6 lg:px-8 py-8",children:s("div",{className:"max-w-4xl mx-auto",children:[s("div",{className:"text-center mb-12",children:[e("h1",{className:"text-4xl sm:text-5xl lg:text-6xl font-black text-gray-900 mb-4",children:"Marksheet Details"}),s("p",{className:"text-lg text-gray-600 max-w-3xl mx-auto",children:["View, verify, and manage individual student marksheet details.",e("br",{}),"Track pass/fail/absent outcomes, dispatch status, and update student information as needed."]})]}),s("div",{className:"glass-card p-8 rounded-3xl transform transition-all duration-200 hover:-translate-y-0.5 hover:shadow-md hover:border-gray-300",children:[s("div",{className:"flex items-center justify-between mb-6",children:[e("h2",{className:"text-3xl font-bold text-gray-900",children:(R=t.studentDetails)==null?void 0:R.name}),e("span",{className:"px-3 py-1 rounded-full text-xs font-semibold ".concat(m.className),children:m.label.toUpperCase()})]}),s("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[s("div",{className:"bg-white p-6 rounded-xl border border-gray-200 transform transition-all duration-200 hover:-translate-y-0.5 hover:shadow-md hover:border-gray-300",children:[e("h2",{className:"text-lg font-semibold text-gray-900 mb-3",children:"Student"}),u?s("div",{className:"space-y-3",children:[s("div",{children:[e("label",{className:"block text-sm text-gray-600 mb-1",children:"Name"}),e("input",{value:y.studentDetails.name||"",onChange:r=>b(a=>({...a,studentDetails:{...a.studentDetails,name:r.target.value}})),className:"w-full border rounded-lg px-3 py-2"})]}),s("div",{children:[e("label",{className:"block text-sm text-gray-600 mb-1",children:"Reg No"}),e("input",{value:y.studentDetails.regNumber||"",onChange:r=>b(a=>({...a,studentDetails:{...a.studentDetails,regNumber:r.target.value}})),className:"w-full border rounded-lg px-3 py-2"})]}),s("div",{className:"grid grid-cols-2 gap-3",children:[s("div",{children:[e("label",{className:"block text-sm text-gray-600 mb-1",children:"Year"}),e("input",{value:y.studentDetails.year||"",onChange:r=>b(a=>({...a,studentDetails:{...a.studentDetails,year:r.target.value}})),className:"w-full border rounded-lg px-3 py-2",placeholder:"e.g., II"})]}),s("div",{children:[e("label",{className:"block text-sm text-gray-600 mb-1",children:"Semester"}),e("input",{value:y.semester||y.studentDetails.semester||"",onChange:r=>b(a=>({...a,semester:r.target.value})),className:"w-full border rounded-lg px-3 py-2",placeholder:"e.g., 1"})]})]}),s("div",{children:[e("label",{className:"block text-sm text-gray-600 mb-1",children:"Department"}),e("input",{value:y.studentDetails.department||"",onChange:r=>b(a=>({...a,studentDetails:{...a.studentDetails,department:r.target.value}})),className:"w-full border rounded-lg px-3 py-2"})]}),s("div",{children:[e("label",{className:"block text-sm text-gray-600 mb-1",children:"Parent Phone"}),e("input",{value:y.studentDetails.parentPhoneNumber||"",onChange:r=>b(a=>({...a,studentDetails:{...a.studentDetails,parentPhoneNumber:r.target.value}})),className:"w-full border rounded-lg px-3 py-2"})]})]}):s(S,{children:[s("p",{className:"text-gray-700",children:[e("strong",{children:"Reg No:"})," ",(_=t.studentDetails)==null?void 0:_.regNumber]}),s("p",{className:"text-gray-700",children:[e("strong",{children:"Year/Sem:"})," ",(j=t.studentDetails)==null?void 0:j.year,"/",t.semester||((C=t.studentDetails)==null?void 0:C.semester)||"N/A"]}),s("p",{className:"text-gray-700",children:[e("strong",{children:"Department:"})," ",(I=t.studentDetails)==null?void 0:I.department]}),s("p",{className:"text-gray-700",children:[e("strong",{children:"Parent:"})," ",(M=t.studentDetails)==null?void 0:M.parentPhoneNumber]})]})]}),s("div",{className:"bg-white p-6 rounded-xl border border-gray-200 transform transition-all duration-200 hover:-translate-y-0.5 hover:shadow-md hover:border-gray-300",children:[e("h2",{className:"text-lg font-semibold text-gray-900 mb-3",children:"Summary"}),s("p",{className:"text-gray-700",children:[e("strong",{children:"Examination Name:"})," ",t.examinationName||"N/A"]}),s("p",{className:"text-gray-700",children:[e("strong",{children:"Examination Date:"})," ",t.examinationDate?new Date(t.examinationDate).toLocaleString("default",{month:"long",year:"numeric"}):"N/A"]}),s("p",{className:"text-gray-700",children:[e("strong",{children:"Overall Result:"})," ",q]}),s("p",{className:"text-gray-700",children:[e("strong",{children:"Staff:"})," ",t.staffName]}),t.hodName&&s("p",{className:"text-gray-700",children:[e("strong",{children:"HOD:"})," ",t.hodName]}),t.status==="approved_by_hod"&&((E=t.dispatchRequest)==null?void 0:E.respondedAt)&&s("p",{className:"text-gray-700",children:[e("strong",{children:"Approved On:"})," ",new Date(t.dispatchRequest.respondedAt).toLocaleString()]})]})]}),((F=t.dispatchRequest)==null?void 0:F.hodResponse)&&s("div",{className:"mt-6 bg-white p-6 rounded-xl border border-gray-200",children:[e("h2",{className:"text-lg font-semibold text-gray-900 mb-3",children:"Dispatch Notes"}),s("dl",{className:"space-y-2 text-gray-700",children:[((A=t.dispatchRequest)==null?void 0:A.hodResponse)&&s("div",{className:"flex flex-col sm:flex-row sm:items-center sm:justify-between",children:[e("dt",{className:"font-medium",children:"HOD Decision"}),e("dd",{className:"capitalize",children:t.dispatchRequest.hodResponse})]}),((O=t.dispatchRequest)==null?void 0:O.hodComments)&&s("div",{children:[e("dt",{className:"font-medium",children:"Comments"}),e("dd",{className:"text-gray-700 mt-1",children:t.dispatchRequest.hodComments})]})]})]}),s("div",{className:"mt-8 bg-white p-6 rounded-xl border border-gray-200 transform transition-all duration-200 hover:-translate-y-0.5 hover:shadow-md hover:border-gray-300",children:[e("h2",{className:"text-lg font-semibold text-gray-900 mb-3",children:"Subjects"}),u?e("div",{className:"space-y-3",children:y.subjects.map((r,a)=>s("div",{className:"grid grid-cols-3 gap-3 items-center",children:[e("input",{value:r.subjectName,onChange:d=>b(g=>{const x=[...g.subjects];return x[a]={...x[a],subjectName:d.target.value},{...g,subjects:x}}),className:"border rounded-lg px-3 py-2"}),e("input",{type:"number",value:r.marks,onChange:d=>b(g=>{const x=[...g.subjects];return x[a]={...x[a],marks:Number(d.target.value)},{...g,subjects:x}}),className:"border rounded-lg px-3 py-2"}),s("select",{value:r.result||"",onChange:d=>b(g=>{const x=[...g.subjects];return x[a]={...x[a],result:d.target.value},{...g,subjects:x}}),className:"border rounded-lg px-3 py-2",children:[e("option",{value:"",children:"Select Result"}),e("option",{value:"Pass",children:"Pass"}),e("option",{value:"Fail",children:"Fail"}),e("option",{value:"Absent",children:"Absent"})]})]},a))}):e("div",{className:"divide-y divide-gray-100",children:(t.subjects||[]).map((r,a)=>{var d;return s("div",{className:"py-3 space-y-1 sm:space-y-0 sm:grid sm:grid-cols-2 sm:items-center",children:[e("span",{className:"text-gray-800 break-words min-w-0",children:r.subjectName}),s("div",{className:"flex items-center justify-between sm:justify-end gap-2 text-gray-700",children:[e("span",{className:"font-semibold",children:(d=r.marks)!=null?d:"—"}),s("span",{className:"whitespace-nowrap",children:["Result: ",P(r)]})]})]},a)})})]}),s("div",{className:"mt-8 flex flex-col sm:flex-row gap-3",children:[e("button",{onClick:()=>N(-1),className:"px-5 py-2 bg-gray-100 text-gray-800 rounded-lg transform transition-all duration-200 hover:-translate-y-0.5 hover:shadow-md w-full sm:w-auto",children:"Back"}),!u&&k&&s(S,{children:[e(J,{marksheet:t,onVerified:h}),e("button",{onClick:()=>w(!0),className:"px-5 py-2 bg-blue-600 text-white rounded-lg transform transition-all duration-200 hover:-translate-y-0.5 hover:shadow-md w-full sm:w-auto",children:"Edit & Regenerate"})]}),!u&&(k||$)&&s("div",{className:"flex gap-2 w-full sm:w-auto",children:[e(Y,{id:t._id,onRefreshed:h}),e("button",{onClick:r=>{r.preventDefault();const a=Date.now(),d=window.location.origin,g=d?"".concat(d,"/api/generate-pdf?marksheetId=").concat(t._id,"&t=").concat(a):"/api/generate-pdf?marksheetId=".concat(t._id,"&t=").concat(a);window.open(g,"_blank")},className:"px-5 py-2 rounded-lg transform transition-all duration-200 hover:-translate-y-0.5 hover:shadow-md w-full sm:w-auto bg-yellow-600 text-white",children:"Download PDF"})]}),u&&k&&s(S,{children:[e("button",{onClick:()=>w(!1),className:"px-5 py-2 bg-gray-200 text-gray-800 rounded-lg transform transition-all duration-200 hover:-translate-y-0.5 hover:shadow-md w-full sm:w-auto",children:"Cancel"}),e(z,{id:t._id,form:y,onSaved:r=>{h(r),w(!1)}})]})]})]})]})})})}function J({marksheet:l,onVerified:N}){const[t,h]=c.useState(!1),[v,f]=c.useState(""),[p,i]=c.useState(!1),[u]=c.useState(()=>{try{const n=localStorage.getItem("auth");return n?JSON.parse(n):null}catch(n){return null}});c.useEffect(()=>{(l==null?void 0:l.status)==="verified_by_staff"||(l==null?void 0:l.status)==="approved_by_hod"||(l==null?void 0:l.status)==="dispatched"?i(!0):i(!1)},[l]);const w=["approved_by_hod","rejected_by_hod","dispatched"],{showError:y}=V(),b=async()=>{let n=u;try{const m=localStorage.getItem("auth");m&&(n=JSON.parse(m))}catch(m){console.error("Error refreshing user data:",m)}if(!(n!=null&&n.eSignature)){const m=(n==null?void 0:n._id)||(n==null?void 0:n.id)||localStorage.getItem("userId");if(m)try{const o=await D.get("/api/users?action=profile&userId=".concat(m));o!=null&&o.success&&o.user&&(n={...n,...o.user},localStorage.setItem("auth",JSON.stringify(n)))}catch(o){console.error("Error fetching user profile:",o)}}h(!0),f("");try{const m=(n==null?void 0:n.eSignature)||null;if(!m){try{y("Signature Missing","Please add your signature in Settings before verifying this marksheet")}catch(o){}h(!1);return}try{const o=await D.post("/api/marksheets?action=verify",m?{marksheetId:l._id,staffSignature:m}:{marksheetId:l._id});!o||!o.success?f((o==null?void 0:o.error)||"Verification failed"):(i(!0),N(o.marksheet))}catch(o){f(o.message||"Verification failed")}}catch(m){f(m.message||"Unexpected error")}finally{h(!1)}};return s(S,{children:[e("button",{disabled:t||p||w.includes(l==null?void 0:l.status),onClick:b,className:"px-5 py-2 rounded-lg transform transition-all duration-200 hover:-translate-y-0.5 hover:shadow-md w-full sm:w-auto ".concat(p||w.includes(l==null?void 0:l.status)?"bg-green-200 text-green-900 cursor-not-allowed":t?"bg-green-200 text-green-900":"bg-green-600 text-white"),children:p?"Verified":t?"Verifying...":"Verify"}),v&&e("span",{className:"text-red-600 text-sm ml-2",children:v})]})}function z({id:l,form:N,onSaved:t}){const[h,v]=c.useState(!1),[f,p]=c.useState("");return s(S,{children:[e("button",{disabled:h,onClick:async()=>{v(!0),p("");try{try{const u=await D.put("/api/marksheets",{marksheetId:l,studentDetails:N.studentDetails,subjects:N.subjects,regenerateSignatures:!0});!u||!u.success?p((u==null?void 0:u.error)||"Save failed"):t(u.marksheet)}catch(u){p(u.message||"Save failed")}}catch(u){p(u.message||"Unexpected error")}finally{v(!1)}},className:"px-5 py-2 rounded-lg transform transition-all duration-200 hover:-translate-y-0.5 hover:shadow-md w-full sm:w-auto ".concat(h?"bg-blue-200 text-blue-900":"bg-blue-600 text-white"),children:h?"Saving...":"Save Changes"}),f&&e("span",{className:"text-red-600 text-sm ml-2",children:f})]})}function Y({id:l,onRefreshed:N}){const[t,h]=c.useState(!1),{showSuccess:v,showError:f}=V();return e("button",{onClick:async()=>{h(!0);try{try{const i=await D.put("/api/marksheets",{marksheetId:l,regenerateSignatures:!0});!i||!i.success?f("Refresh Failed",(i==null?void 0:i.error)||"Could not refresh signatures"):(v("Signatures Refreshed","Staff/HOD signatures were updated on this marksheet"),typeof N=="function"&&N(i.marksheet))}catch(i){f("Refresh Failed",i.message||"Could not refresh signatures")}}catch(i){f("Refresh Failed",i.message||"Unexpected error")}finally{h(!1)}},disabled:t,className:"px-5 py-2 rounded-lg transform transition-all duration-200 hover:-translate-y-0.5 hover:shadow-md w-full sm:w-auto ".concat(t?"bg-gray-200 text-gray-800":"bg-indigo-600 text-white"),children:t?"Refreshing...":"Refresh Signatures"})}export{Q as default};
