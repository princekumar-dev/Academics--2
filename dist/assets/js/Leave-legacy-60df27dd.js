System.register(["./index-legacy-539dcb9c.js","./react-vendor-legacy-4587369d.js","./Confetti-legacy-a1de8ee6.js","./ConfirmDialog-legacy-e002b08d.js"],function(e,t){"use strict";var a,r,l,n,i,s,o,d,c,m,u,g,p;return{setters:[e=>{a=e.j,r=e.u,l=e.d,n=e.e,i=e.b,s=e.F,o=e.S,d=e.a,c=e.g},e=>{m=e.N,u=e.r},e=>{g=e.u},e=>{p=e.C}],execute:function(){e("default",function(){const e=localStorage.getItem("auth"),t=e?JSON.parse(e):null;if(!t||"student"!==t.role)return a(m,{to:"/home",replace:!0});const{showSuccess:h,showError:v}=r(),{celebrate:b,ConfettiContainer:x}=g(),[f,y]=u.useState(()=>localStorage.getItem("leaveTabSelection")||"leave"),[N,w]=u.useState(""),[S,C]=u.useState(!1),[T,_]=u.useState(""),[D,L]=u.useState(""),[I,E]=u.useState(""),[k,q]=u.useState(!1),[$,M]=u.useState([]),[O,A]=u.useState(!1),[j,P]=u.useState(()=>{const e=localStorage.getItem("activeTimer")||sessionStorage.getItem("activeTimer");return e?JSON.parse(e):null}),[R,J]=u.useState(0),[F,U]=u.useState(null),[z,B]=u.useState(null),G=t.id,Y=u.useMemo(()=>"\n    @keyframes pulseGlow {\n      0% { box-shadow: 0 0 0 0 rgba(59,130,246,0.6); }\n      70% { box-shadow: 0 0 0 10px rgba(59,130,246,0); }\n      100% { box-shadow: 0 0 0 0 rgba(59,130,246,0); }\n    }\n    .pulse-glow { animation: pulseGlow 2s ease-in-out infinite; }\n\n    .segmented-control { position: relative; }\n    .segmented-highlight { position: absolute; top: 0.25rem; bottom: 0.25rem; background: rgba(37,99,235,0.08); border: 1px solid rgba(37,99,235,0.2); border-radius: 0.75rem; transition: left 200ms ease; }\n  ",[]),H=async(e=!1)=>{try{A(!0);const t=e?{cache:!1,dedupe:!1}:void 0,a=await d.get(`/api/leaves?studentId=${G}`,t);a.success&&M(a.requests||[])}catch(t){}finally{A(!1)}};u.useEffect(()=>{H();const e=()=>H(!0);return window.addEventListener("notificationsUpdated",e),window.addEventListener("marksheetsUpdated",e),()=>{window.removeEventListener("notificationsUpdated",e),window.removeEventListener("marksheetsUpdated",e)}},[]),l({late_arrival:()=>{console.log("ðŸ”” Late arrival notification triggered refresh"),H()}}),n(()=>{H();const e=localStorage.getItem("leaveTabSelection")||"leave";y(e)}),u.useEffect(()=>{const e=()=>{if(!document.hidden){const e=localStorage.getItem("activeTimer");if(e){const t=JSON.parse(e);P(t)}}},t=e=>{if(e.persisted){const e=localStorage.getItem("activeTimer");if(e){const t=JSON.parse(e);P(t)}}};return document.addEventListener("visibilitychange",e),window.addEventListener("pageshow",t),()=>{document.removeEventListener("visibilitychange",e),window.removeEventListener("pageshow",t)}},[]),u.useEffect(()=>{j?(localStorage.setItem("activeTimer",JSON.stringify(j)),sessionStorage.setItem("activeTimer",JSON.stringify(j))):(localStorage.removeItem("activeTimer"),sessionStorage.removeItem("activeTimer"))},[j]),u.useEffect(()=>{localStorage.setItem("leaveTabSelection",f)},[f]),u.useEffect(()=>{if(!j)return;const e=setInterval(()=>{J(e=>e+1)},1e3);return()=>clearInterval(e)},[j]),u.useEffect(()=>{"late"!==f||I||E((()=>{const e=new Date;e.setMinutes(e.getMinutes()+30);const t=e=>`${e}`.padStart(2,"0");return`${t(e.getHours())}:${t(e.getMinutes())}`})())},[f]);const W=N.length,K=u.useMemo(()=>{if(!T||!D)return 0;const e=new Date(T),t=new Date(D),a=Math.ceil((t-e)/864e5)+1;return isNaN(a)||a<0?0:a},[T,D]);u.useEffect(()=>{if(T&&D){const e=new Date(T);new Date(D)<e&&L(T)}},[T,D]);const Q=e=>e?new Date(e).toLocaleString("en-IN",{dateStyle:"medium",timeStyle:"short"}):"-",V=e=>e?new Date(e).toLocaleString("en-IN",{dateStyle:"medium"}):"-";try{window.refreshNotificationCount&&window.refreshNotificationCount()}catch(Z){}const X=e=>{B({title:"Delete leave request?",message:"This will permanently delete your leave request. This action cannot be undone. Continue?",onConfirm:()=>(async e=>{try{const t=await d.del(`/api/leaves?id=${e._id}&action=delete`,{body:{}});t&&t.success?(h("Success","Leave request deleted successfully"),H(!0)):(v("Failed",t.error||"Could not delete request"),console.error("Delete error:",t))}catch(t){v("Error",c(t,"Could not complete. Please try again.")),console.error("Delete exception:",t)}})(e)})};return i(s,{children:[i("div",{className:"px-4 py-4 w-full max-w-4xl mx-auto",children:[a("style",{children:Y}),a(x,{}),a("h1",{className:"text-2xl font-bold mb-4",children:"Leave / Late"}),i("form",{onSubmit:async e=>{if(e.preventDefault(),C(!0),N.trim())if(N.length>200)v("Too long","Reason should be under 200 characters.");else{if("leave"===f){if(!T||!D)return void v("Missing dates","Please provide start and end dates.");if(K<=0)return void v("Invalid dates","End date must be the same or after start date.")}else if(!I)return void v("Missing time","Please provide expected arrival time.");q(!0);try{const e={type:f,reason:N,regNumber:t.regNumber,phoneNumber:t.phoneNumber};if("leave"===f)e.startDate=T,e.endDate=D;else{const t=(new Date).toISOString().split("T")[0];e.expectedArrivalTime=`${t}T${I}`}const a=await d.post("/api/leaves?action=create",e);a&&a.success?(h("Request submitted",("leave"===f?"Leave":"Late")+" request created"),b(),w(""),_(""),L(""),E(""),y("leave"),H(!0)):v("Failed",a.error||"Could not submit request")}catch(a){v("Error",c(a,"Could not submit. Please try again."))}finally{q(!1)}}else v("Missing reason","Please provide a reason.")},className:"bg-white rounded-2xl shadow p-5 mb-6 space-y-5",children:[i("div",{className:"segmented-control relative p-1 rounded-xl bg-white",children:[a("div",{className:"segmented-highlight",style:{left:"leave"===f?"0.25rem":"calc(50% + 0.25rem)",width:"calc(50% - 0.5rem)"}}),i("div",{className:"grid grid-cols-2 gap-0",children:[a("button",{type:"button",onClick:()=>y("leave"),className:"relative z-10 px-4 py-3 rounded-xl text-sm font-bold transition-all "+("leave"===f?"text-blue-700":"text-blue-600 hover:bg-blue-50"),children:"Leave"}),a("button",{type:"button",onClick:()=>y("late"),className:"relative z-10 px-4 py-3 rounded-xl text-sm font-bold transition-all "+("late"===f?"text-blue-700":"text-blue-600 hover:bg-blue-50"),children:"Late"})]})]}),i("div",{children:[a("label",{className:"block text-sm font-semibold mb-1",children:"Reason"}),i("div",{className:"relative",children:[a("input",{value:N,onChange:e=>w(e.target.value),onBlur:()=>C(!0),maxLength:300,className:`w-full border rounded-xl px-3 py-3 pr-14 transition-all ${S&&!N.trim()?"border-red-400 focus:border-red-500":"border-gray-300 focus:border-blue-500"} ${W>160?"pulse-glow":""}`,placeholder:"Briefly explain your reason (e.g., Medical checkup)"}),i("div",{className:"absolute right-3 top-1/2 -translate-y-1/2 text-xs text-gray-500 pointer-events-none",children:[W,"/",200]})]}),S&&!N.trim()&&a("p",{className:"text-xs text-red-600 mt-1",children:"Please provide a reason."})]}),i("div","leave"===f?{className:"grid grid-cols-1 md:grid-cols-2 gap-3",children:[i("div",{children:[a("label",{className:"block text-sm font-semibold mb-1",children:"Start Date"}),a("input",{type:"date",value:T,onChange:e=>_(e.target.value),min:(new Date).toISOString().split("T")[0],className:"w-full border rounded-xl px-3 py-3"})]}),i("div",{children:[a("label",{className:"block text-sm font-semibold mb-1",children:"End Date"}),a("input",{type:"date",value:D,onChange:e=>L(e.target.value),min:T||(new Date).toISOString().split("T")[0],className:"w-full border rounded-xl px-3 py-3"})]}),a("div",{className:"md:col-span-2 text-sm text-gray-600",children:T&&D?`Total days: ${K}`:"Select dates to compute total days"})]}:{children:[a("label",{className:"block text-sm font-semibold mb-1",children:"Expected Arrival Time"}),i("div",{className:"flex items-center gap-3 mb-1",children:[a("div",{className:"flex-1",children:a("input",{type:"date",value:(new Date).toISOString().split("T")[0],disabled:!0,className:"w-full border rounded-xl px-3 py-3 bg-gray-100 text-gray-600 cursor-not-allowed"})}),a("div",{className:"flex-1",children:a("input",{type:"time",value:I,onChange:e=>E(e.target.value),className:"w-full border rounded-xl px-3 py-3",required:!0})})]}),a("p",{className:"text-xs text-gray-600",children:"Tip: Defaults to +30 minutes from now"})]}),i("div",{className:"flex items-center gap-3",children:[a("button",{disabled:k,className:"px-5 py-3 rounded-xl bg-blue-600 text-white disabled:opacity-50 transition-transform hover:scale-[1.02]",children:"Submit"}),a("button",{type:"button",onClick:()=>{y("leave"),w(""),C(!1),_(""),L(""),E("")},className:"px-4 py-3 rounded-xl border text-gray-700",children:"Clear"})]})]}),i("div",{className:"bg-white rounded-2xl shadow mb-6",children:[a("div",{className:"p-4 border-b",children:a("h2",{className:"font-semibold",children:"Summary"})}),i("div",{className:"p-4 grid grid-cols-1 md:grid-cols-2 gap-3 text-sm",children:[i("div",{children:[a("span",{className:"text-gray-500",children:"Student:"})," ",t.name," (",t.regNumber,")"]}),i("div",{children:[a("span",{className:"text-gray-500",children:"Type:"})," ","leave"===f?"Leave":"Late"]}),"leave"===f?i(s,{children:[i("div",{children:[a("span",{className:"text-gray-500",children:"Period:"})," ",T||"â€”"," â†’ ",D||"â€”"]}),i("div",{children:[a("span",{className:"text-gray-500",children:"Total days:"})," ",K||"â€”"]})]}):i("div",{children:[a("span",{className:"text-gray-500",children:"Expected arrival:"})," ",I?`Today at ${I}`:"â€”"]}),i("div",{className:"md:col-span-2",children:[a("span",{className:"text-gray-500",children:"Reason:"})," ",N||"â€”"]})]})]}),i("div",{className:"bg-white rounded-2xl shadow",children:[a("div",{className:"p-4 border-b",children:a("h2",{className:"font-semibold",children:"My Requests"})}),O?a("div",{className:"p-4 text-gray-500",children:"Loading..."}):a("ul",{className:"divide-y",children:(()=>{const e=$.filter(e=>e.type===f);return 0===e.length?a("li",{className:"p-4 text-center text-gray-500",children:0===$.length?"No requests yet.":`No ${f} requests found.`}):e.map(e=>{const t="leave"===e.type&&["requested","waiting_for_arrival_confirmation","rejected_by_hod"].includes(e.status),r="leave"===e.type?[...t?[{label:"Delete",icon:"ðŸ—‘ï¸",onClick:()=>X(e),className:"bg-red-600 hover:bg-red-700 text-white",direction:"right",autoTrigger:!0}]:[],..."approved_by_hod"===e.status?[{label:"Download",icon:"ðŸ“„",onClick:()=>{const t=document.createElement("a");t.href=`/api/generate-pdf?type=leave&leaveId=${e._id}`,t.download=`leave-approval-${e._id}.pdf`,document.body.appendChild(t),t.click(),document.body.removeChild(t)},className:"bg-blue-600 hover:bg-blue-700 text-white"}]:[]]:[],l=j?._id===e._id;return a("li",{className:"p-0 hover:bg-gray-50 transition-colors",children:a(o,{actions:r,children:l&&"late"===e.type&&"waiting_for_arrival_confirmation"===e.status?i("div",{className:"px-4 py-4 bg-gradient-to-br from-green-50 to-emerald-50 border-t-2 border-green-300",children:[i("div",{className:"mb-3",children:[a("div",{className:"font-semibold text-gray-900 mb-1",children:"Late Arrival - On the way"}),i("div",{className:"text-sm text-gray-700",children:[a("strong",{children:"Reason:"})," ",e.reason]}),i("div",{className:"text-sm text-gray-600",children:["Expected: ",Q(e.expectedArrivalTime)]})]}),i("div",{className:"bg-white rounded-lg p-2 sm:p-3 mb-3 border border-green-200 text-center",children:[a("p",{className:"text-xs text-gray-600 mb-1",children:"You reached at"}),a("p",{className:"text-xl sm:text-2xl md:text-3xl font-bold text-green-600 font-mono leading-tight",children:F?new Date(F).toLocaleTimeString("en-IN",{hour:"2-digit",minute:"2-digit",second:"2-digit"}):(new Date).toLocaleTimeString("en-IN",{hour:"2-digit",minute:"2-digit",second:"2-digit"})})]}),a("button",{onClick:()=>(async e=>{try{const t=await d.patch(`/api/leaves?id=${e._id}&action=confirm-arrival`,{});if(t&&t.success){const e=t.request&&t.request.arrivalConfirmedAt?t.request.arrivalConfirmedAt:new Date;U(e),h("Success","Your arrival has been confirmed and parent has been notified!"),localStorage.removeItem("activeTimer"),sessionStorage.removeItem("activeTimer"),P(null),J(0),H(!0)}else v("Failed",t.error||"Could not confirm arrival"),console.error("Confirm arrival error:",t)}catch(t){v("Error",c(t,"Could not complete. Please try again.")),console.error("Confirm arrival exception:",t)}})(e),className:"w-full px-4 py-3 bg-green-600 hover:bg-green-700 text-white font-semibold rounded-lg transition-colors",children:"âœ… I've Reached College"}),a("button",{onClick:()=>{P(null),J(0),U(null)},className:"w-full px-4 py-2 mt-2 bg-gray-200 hover:bg-gray-300 text-gray-700 font-semibold rounded-lg transition-colors",children:"Cancel"})]}):i("div",{className:"px-4 py-3",children:[i("div",{className:"flex items-center justify-between mb-2",children:[i("div",{className:"flex-1 pr-4",children:[i("div",{className:"font-medium text-gray-900 flex items-center gap-2",children:["leave"===e.type?"Leave":"Late","late"===e.type&&"waiting_for_arrival_confirmation"===e.status&&a("span",{className:"text-xs font-bold px-2 py-1 rounded-full bg-yellow-100 text-yellow-800",children:"Waiting for you"})]}),i("div",{className:"text-sm text-gray-600",children:["Reason: ",e.reason]}),i("div",{className:"text-sm text-gray-600",children:["Status: ",e.status]}),"leave"===e.type?i("div",{className:"text-sm text-gray-600",children:[V(e.startDate)," â†’ ",V(e.endDate)]}):i("div",{className:"text-sm text-gray-600",children:["Expected: ",Q(e.expectedArrivalTime)," ",e.arrivalConfirmedAt?` | Arrived: ${Q(e.arrivalConfirmedAt)}`:""]})]}),"leave"===e.type&&"approved_by_hod"===e.status&&a("a",{href:`/api/generate-pdf?type=leave&leaveId=${e._id}`,className:"hidden sm:flex px-3 py-2 text-sm rounded-lg border text-blue-600 border-blue-600 ml-4 flex-shrink-0",children:"Download Letter"})]}),"leave"===e.type&&(t||"approved_by_hod"===e.status)&&i("div",{className:"sm:hidden p-2 bg-gradient-to-r from-blue-50 to-red-50 border-t border-gray-200 rounded-b text-center space-y-1",children:["approved_by_hod"===e.status&&i("p",{className:"text-xs text-gray-600 flex items-center justify-center gap-2",children:[a("span",{children:"ðŸ‘ˆ"}),a("span",{className:"font-medium",children:"Swipe left to download"})]}),t&&i("p",{className:"text-xs text-gray-600 flex items-center justify-center gap-2",children:[a("span",{children:"ðŸ‘‰"}),a("span",{className:"font-medium",children:"Swipe right to delete"})]})]}),"late"===e.type&&"waiting_for_arrival_confirmation"===e.status&&a("div",{className:"p-3 bg-yellow-50 border-t border-yellow-100 rounded-b text-center",children:a("button",{onClick:()=>{P(e),J(0),U(null)},className:"w-full px-3 py-2 text-sm rounded-lg bg-green-100 text-green-700 hover:bg-green-200",children:"â± Start Timer"})})]})})},e._id)})})()})]})]}),z&&a(p,{open:!0,title:z.title,description:z.message,confirmLabel:"Delete",cancelLabel:"Cancel",onConfirm:()=>{z.onConfirm(),B(null)},onCancel:()=>B(null)})]})})}}});
