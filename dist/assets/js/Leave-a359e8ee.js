import{j as t,u as ee,d as te,e as ae,b as s,F,S as se,a as C}from"./index-a36099b1.js";import{N as re,r}from"./react-vendor-ad4d5528.js";import{u as le}from"./Confetti-9ac51eaf.js";import{C as ne}from"./ConfirmDialog-fc8aca83.js";function ue(){const k=localStorage.getItem("auth"),g=k?JSON.parse(k):null;if(!g||g.role!=="student")return t(re,{to:"/home",replace:!0});const{showSuccess:T,showError:d}=ee(),{celebrate:J,ConfettiContainer:z}=le(),[l,v]=r.useState(()=>localStorage.getItem("leaveTabSelection")||"leave"),[u,D]=r.useState(""),[R,_]=r.useState(!1),[i,I]=r.useState(""),[c,y]=r.useState(""),[p,N]=r.useState(""),[B,A]=r.useState(!1),[M,G]=r.useState([]),[Y,O]=r.useState(!1),[m,b]=r.useState(()=>{const a=localStorage.getItem("activeTimer")||sessionStorage.getItem("activeTimer");return a?JSON.parse(a):null}),[ie,w]=r.useState(0);r.useState(null);const[S,L]=r.useState(null),H=g.id,V=r.useMemo(()=>"\n    @keyframes pulseGlow {\n      0% { box-shadow: 0 0 0 0 rgba(59,130,246,0.6); }\n      70% { box-shadow: 0 0 0 10px rgba(59,130,246,0); }\n      100% { box-shadow: 0 0 0 0 rgba(59,130,246,0); }\n    }\n    .pulse-glow { animation: pulseGlow 2s ease-in-out infinite; }\n\n    .segmented-control { position: relative; }\n    .segmented-highlight { position: absolute; top: 0.25rem; bottom: 0.25rem; background: rgba(37,99,235,0.08); border: 1px solid rgba(37,99,235,0.2); border-radius: 0.75rem; transition: left 200ms ease; }\n  ",[]),h=async()=>{try{O(!0);const a=await C.get("/api/leaves?studentId=".concat(H));a.success&&G(a.requests||[])}catch(a){}finally{O(!1)}};r.useEffect(()=>{h()},[]),te({late_arrival:()=>{console.log("ðŸ”” Late arrival notification triggered refresh"),h()}}),ae(()=>{h();const a=localStorage.getItem("leaveTabSelection")||"leave";v(a)}),r.useEffect(()=>{const a=()=>{if(!document.hidden){const n=localStorage.getItem("activeTimer");if(n){const o=JSON.parse(n);b(o)}}},e=n=>{if(n.persisted){const o=localStorage.getItem("activeTimer");if(o){const f=JSON.parse(o);b(f)}}};return document.addEventListener("visibilitychange",a),window.addEventListener("pageshow",e),()=>{document.removeEventListener("visibilitychange",a),window.removeEventListener("pageshow",e)}},[]),r.useEffect(()=>{m?(localStorage.setItem("activeTimer",JSON.stringify(m)),sessionStorage.setItem("activeTimer",JSON.stringify(m))):(localStorage.removeItem("activeTimer"),sessionStorage.removeItem("activeTimer"))},[m]),r.useEffect(()=>{localStorage.setItem("leaveTabSelection",l)},[l]),r.useEffect(()=>{if(!m)return;const a=setInterval(()=>{w(e=>e+1)},1e3);return()=>clearInterval(a)},[m]);const W=()=>{const a=new Date;a.setMinutes(a.getMinutes()+30);const e=f=>"".concat(f).padStart(2,"0"),n=e(a.getHours()),o=e(a.getMinutes());return"".concat(n,":").concat(o)};r.useEffect(()=>{l==="late"&&!p&&N(W())},[l]);const E=200,P=u.length,$=r.useMemo(()=>{if(!i||!c)return 0;const a=new Date(i),e=new Date(c),n=Math.ceil((e-a)/(1e3*60*60*24))+1;return isNaN(n)||n<0?0:n},[i,c]);r.useEffect(()=>{if(i&&c){const a=new Date(i);new Date(c)<a&&y(i)}},[i,c]);const K=async a=>{if(a.preventDefault(),_(!0),!u.trim()){d("Missing reason","Please provide a reason.");return}if(u.length>E){d("Too long","Reason should be under ".concat(E," characters."));return}if(l==="leave"){if(!i||!c){d("Missing dates","Please provide start and end dates.");return}if($<=0){d("Invalid dates","End date must be the same or after start date.");return}}else if(!p){d("Missing time","Please provide expected arrival time.");return}A(!0);try{const e={type:l,reason:u,regNumber:g.regNumber,phoneNumber:g.phoneNumber};if(l==="leave")e.startDate=i,e.endDate=c;else{const o=new Date().toISOString().split("T")[0];e.expectedArrivalTime="".concat(o,"T").concat(p)}const n=await C.post("/api/leaves?action=create",e);n&&n.success?(T("Request submitted","".concat(l==="leave"?"Leave":"Late"," request created")),J(),D(""),I(""),y(""),N(""),v("leave"),h()):d("Failed",n.error||"Could not submit request")}catch(e){d("Error",e.message)}finally{A(!1)}},q=a=>a?new Date(a).toLocaleString("en-IN",{dateStyle:"medium",timeStyle:"short"}):"-",j=a=>a?new Date(a).toLocaleString("en-IN",{dateStyle:"medium"}):"-",Q=async a=>{try{const e=await C.patch("/api/leaves?id=".concat(a._id,"&action=confirm-arrival"),{});e&&e.success?(T("Success","Your arrival has been confirmed and parent has been notified!"),localStorage.removeItem("activeTimer"),sessionStorage.removeItem("activeTimer"),b(null),w(0),h()):(d("Failed",e.error||"Could not confirm arrival"),console.error("Confirm arrival error:",e))}catch(e){d("Error",e.message),console.error("Confirm arrival exception:",e)}},U=async a=>{try{const e=await C.del("/api/leaves?id=".concat(a._id,"&action=delete"),{body:{}});e&&e.success?(T("Success","Leave request deleted successfully"),h()):(d("Failed",e.error||"Could not delete request"),console.error("Delete error:",e))}catch(e){d("Error",e.message),console.error("Delete exception:",e)}},X=a=>{L({title:"Delete leave request?",message:"This will permanently delete your leave request. This action cannot be undone. Continue?",onConfirm:()=>U(a)})};return s(F,{children:[s("div",{className:"px-4 py-4 w-full max-w-4xl mx-auto",children:[t("style",{children:V}),t(z,{}),t("h1",{className:"text-2xl font-bold mb-4",children:"Leave / Late"}),s("form",{onSubmit:K,className:"bg-white rounded-2xl shadow p-5 mb-6 space-y-5",children:[s("div",{className:"segmented-control relative p-1 rounded-xl bg-white",children:[t("div",{className:"segmented-highlight",style:{left:l==="leave"?"0.25rem":"calc(50% + 0.25rem)",width:"calc(50% - 0.5rem)"}}),s("div",{className:"grid grid-cols-2 gap-0",children:[t("button",{type:"button",onClick:()=>v("leave"),className:"relative z-10 px-4 py-3 rounded-xl text-sm font-bold transition-all ".concat(l==="leave"?"text-blue-700":"text-blue-600 hover:bg-blue-50"),children:"Leave"}),t("button",{type:"button",onClick:()=>v("late"),className:"relative z-10 px-4 py-3 rounded-xl text-sm font-bold transition-all ".concat(l==="late"?"text-blue-700":"text-blue-600 hover:bg-blue-50"),children:"Late"})]})]}),s("div",{children:[t("label",{className:"block text-sm font-semibold mb-1",children:"Reason"}),s("div",{className:"relative",children:[t("input",{value:u,onChange:a=>D(a.target.value),onBlur:()=>_(!0),maxLength:300,className:"w-full border rounded-xl px-3 py-3 pr-14 transition-all ".concat(R&&!u.trim()?"border-red-400 focus:border-red-500":"border-gray-300 focus:border-blue-500"," ").concat(P>160?"pulse-glow":""),placeholder:"Briefly explain your reason (e.g., Medical checkup)"}),s("div",{className:"absolute right-3 top-1/2 -translate-y-1/2 text-xs text-gray-500 pointer-events-none",children:[P,"/",E]})]}),R&&!u.trim()&&t("p",{className:"text-xs text-red-600 mt-1",children:"Please provide a reason."})]}),l==="leave"?s("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-3",children:[s("div",{children:[t("label",{className:"block text-sm font-semibold mb-1",children:"Start Date"}),t("input",{type:"date",value:i,onChange:a=>I(a.target.value),min:new Date().toISOString().split("T")[0],className:"w-full border rounded-xl px-3 py-3"})]}),s("div",{children:[t("label",{className:"block text-sm font-semibold mb-1",children:"End Date"}),t("input",{type:"date",value:c,onChange:a=>y(a.target.value),min:i||new Date().toISOString().split("T")[0],className:"w-full border rounded-xl px-3 py-3"})]}),t("div",{className:"md:col-span-2 text-sm text-gray-600",children:i&&c?"Total days: ".concat($):"Select dates to compute total days"})]}):s("div",{children:[t("label",{className:"block text-sm font-semibold mb-1",children:"Expected Arrival Time"}),s("div",{className:"flex items-center gap-3 mb-1",children:[t("div",{className:"flex-1",children:t("input",{type:"date",value:new Date().toISOString().split("T")[0],disabled:!0,className:"w-full border rounded-xl px-3 py-3 bg-gray-100 text-gray-600 cursor-not-allowed"})}),t("div",{className:"flex-1",children:t("input",{type:"time",value:p,onChange:a=>N(a.target.value),className:"w-full border rounded-xl px-3 py-3",required:!0})})]}),t("p",{className:"text-xs text-gray-600",children:"Tip: Defaults to +30 minutes from now"})]}),s("div",{className:"flex items-center gap-3",children:[t("button",{disabled:B,className:"px-5 py-3 rounded-xl bg-blue-600 text-white disabled:opacity-50 transition-transform hover:scale-[1.02]",children:"Submit"}),t("button",{type:"button",onClick:()=>{v("leave"),D(""),_(!1),I(""),y(""),N("")},className:"px-4 py-3 rounded-xl border text-gray-700",children:"Clear"})]})]}),s("div",{className:"bg-white rounded-2xl shadow mb-6",children:[t("div",{className:"p-4 border-b",children:t("h2",{className:"font-semibold",children:"Summary"})}),s("div",{className:"p-4 grid grid-cols-1 md:grid-cols-2 gap-3 text-sm",children:[s("div",{children:[t("span",{className:"text-gray-500",children:"Student:"})," ",g.name," (",g.regNumber,")"]}),s("div",{children:[t("span",{className:"text-gray-500",children:"Type:"})," ",l==="leave"?"Leave":"Late"]}),l==="leave"?s(F,{children:[s("div",{children:[t("span",{className:"text-gray-500",children:"Period:"})," ",i||"â€”"," â†’ ",c||"â€”"]}),s("div",{children:[t("span",{className:"text-gray-500",children:"Total days:"})," ",$||"â€”"]})]}):s("div",{children:[t("span",{className:"text-gray-500",children:"Expected arrival:"})," ",p?"Today at ".concat(p):"â€”"]}),s("div",{className:"md:col-span-2",children:[t("span",{className:"text-gray-500",children:"Reason:"})," ",u||"â€”"]})]})]}),s("div",{className:"bg-white rounded-2xl shadow",children:[t("div",{className:"p-4 border-b",children:t("h2",{className:"font-semibold",children:"My Requests"})}),Y?t("div",{className:"p-4 text-gray-500",children:"Loading..."}):t("ul",{className:"divide-y",children:(()=>{const a=M.filter(e=>e.type===l);return a.length===0?t("li",{className:"p-4 text-center text-gray-500",children:M.length===0?"No requests yet.":"No ".concat(l," requests found.")}):a.map(e=>{const n=["requested","waiting_for_arrival_confirmation","rejected_by_hod"],o=e.type==="leave"&&n.includes(e.status),f=e.type==="leave"?[...o?[{label:"Delete",icon:"ðŸ—‘ï¸",onClick:()=>X(e),className:"bg-red-600 hover:bg-red-700 text-white",direction:"right",autoTrigger:!0}]:[],...e.status==="approved_by_hod"?[{label:"Download",icon:"ðŸ“„",onClick:()=>{const x=document.createElement("a");x.href="/api/generate-pdf?type=leave&leaveId=".concat(e._id),x.download="leave-approval-".concat(e._id,".pdf"),document.body.appendChild(x),x.click(),document.body.removeChild(x)},className:"bg-blue-600 hover:bg-blue-700 text-white"}]:[]]:[],Z=(m==null?void 0:m._id)===e._id;return t("li",{className:"p-0 hover:bg-gray-50 transition-colors",children:t(se,{actions:f,children:Z&&e.type==="late"&&e.status==="waiting_for_arrival_confirmation"?s("div",{className:"px-4 py-4 bg-gradient-to-br from-green-50 to-emerald-50 border-t-2 border-green-300",children:[s("div",{className:"mb-3",children:[t("div",{className:"font-semibold text-gray-900 mb-1",children:"Late Arrival - On the way"}),s("div",{className:"text-sm text-gray-700",children:[t("strong",{children:"Reason:"})," ",e.reason]}),s("div",{className:"text-sm text-gray-600",children:["Expected: ",q(e.expectedArrivalTime)]})]}),s("div",{className:"bg-white rounded-lg p-2 sm:p-3 mb-3 border border-green-200 text-center",children:[t("p",{className:"text-xs text-gray-600 mb-1",children:"You reached at"}),t("p",{className:"text-xl sm:text-2xl md:text-3xl font-bold text-green-600 font-mono leading-tight",children:new Date().toLocaleTimeString("en-IN",{hour:"2-digit",minute:"2-digit",second:"2-digit"})})]}),t("button",{onClick:()=>Q(e),className:"w-full px-4 py-3 bg-green-600 hover:bg-green-700 text-white font-semibold rounded-lg transition-colors",children:"âœ… I've Reached College"}),t("button",{onClick:()=>{b(null),w(0)},className:"w-full px-4 py-2 mt-2 bg-gray-200 hover:bg-gray-300 text-gray-700 font-semibold rounded-lg transition-colors",children:"Cancel"})]}):s("div",{className:"px-4 py-3",children:[s("div",{className:"flex items-center justify-between mb-2",children:[s("div",{className:"flex-1 pr-4",children:[s("div",{className:"font-medium text-gray-900 flex items-center gap-2",children:[e.type==="leave"?"Leave":"Late",e.type==="late"&&e.status==="waiting_for_arrival_confirmation"&&t("span",{className:"text-xs font-bold px-2 py-1 rounded-full bg-yellow-100 text-yellow-800",children:"Waiting for you"})]}),s("div",{className:"text-sm text-gray-600",children:["Reason: ",e.reason]}),s("div",{className:"text-sm text-gray-600",children:["Status: ",e.status]}),e.type==="leave"?s("div",{className:"text-sm text-gray-600",children:[j(e.startDate)," â†’ ",j(e.endDate)]}):s("div",{className:"text-sm text-gray-600",children:["Expected: ",q(e.expectedArrivalTime)," ",e.arrivalConfirmedAt?" | Arrived: ".concat(q(e.arrivalConfirmedAt)):""]})]}),e.type==="leave"&&e.status==="approved_by_hod"&&t("a",{href:"/api/generate-pdf?type=leave&leaveId=".concat(e._id),className:"hidden sm:flex px-3 py-2 text-sm rounded-lg border text-blue-600 border-blue-600 ml-4 flex-shrink-0",children:"Download Letter"})]}),e.type==="leave"&&(o||e.status==="approved_by_hod")&&s("div",{className:"sm:hidden p-2 bg-gradient-to-r from-blue-50 to-red-50 border-t border-gray-200 rounded-b text-center space-y-1",children:[e.status==="approved_by_hod"&&s("p",{className:"text-xs text-gray-600 flex items-center justify-center gap-2",children:[t("span",{children:"ðŸ‘ˆ"}),t("span",{className:"font-medium",children:"Swipe left to download"})]}),o&&s("p",{className:"text-xs text-gray-600 flex items-center justify-center gap-2",children:[t("span",{children:"ðŸ‘‰"}),t("span",{className:"font-medium",children:"Swipe right to delete"})]})]}),e.type==="late"&&e.status==="waiting_for_arrival_confirmation"&&t("div",{className:"p-3 bg-yellow-50 border-t border-yellow-100 rounded-b text-center",children:t("button",{onClick:()=>{b(e),w(0)},className:"w-full px-3 py-2 text-sm rounded-lg bg-green-100 text-green-700 hover:bg-green-200",children:"â± Start Timer"})})]})})},e._id)})})()})]})]}),S&&t(ne,{open:!0,title:S.title,description:S.message,confirmLabel:"Delete",cancelLabel:"Cancel",onConfirm:()=>{S.onConfirm(),L(null)},onCancel:()=>L(null)})]})}export{ue as default};
