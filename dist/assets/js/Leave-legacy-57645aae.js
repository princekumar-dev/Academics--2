System.register(["./index-legacy-b6735175.js","./react-vendor-legacy-4587369d.js","./Confetti-legacy-98c8a395.js","./ConfirmDialog-legacy-0bad690d.js"],function(e,t){"use strict";var a,r,l,s,n,i,o,d,c,m,u,g;return{setters:[e=>{a=e.j,r=e.u,l=e.d,s=e.e,n=e.b,i=e.F,o=e.S,d=e.a},e=>{c=e.N,m=e.r},e=>{u=e.u},e=>{g=e.C}],execute:function(){e("default",function(){const e=localStorage.getItem("auth"),t=e?JSON.parse(e):null;if(!t||"student"!==t.role)return a(c,{to:"/home",replace:!0});const{showSuccess:p,showError:h}=r(),{celebrate:v,ConfettiContainer:b}=u(),[x,f]=m.useState(()=>localStorage.getItem("leaveTabSelection")||"leave"),[y,N]=m.useState(""),[w,S]=m.useState(!1),[C,T]=m.useState(""),[_,L]=m.useState(""),[D,I]=m.useState(""),[E,k]=m.useState(!1),[$,q]=m.useState([]),[M,O]=m.useState(!1),[j,A]=m.useState(()=>{const e=localStorage.getItem("activeTimer")||sessionStorage.getItem("activeTimer");return e?JSON.parse(e):null}),[R,J]=m.useState(0);m.useState(null);const[P,F]=m.useState(null),U=t.id,z=m.useMemo(()=>"\n    @keyframes pulseGlow {\n      0% { box-shadow: 0 0 0 0 rgba(59,130,246,0.6); }\n      70% { box-shadow: 0 0 0 10px rgba(59,130,246,0); }\n      100% { box-shadow: 0 0 0 0 rgba(59,130,246,0); }\n    }\n    .pulse-glow { animation: pulseGlow 2s ease-in-out infinite; }\n\n    .segmented-control { position: relative; }\n    .segmented-highlight { position: absolute; top: 0.25rem; bottom: 0.25rem; background: rgba(37,99,235,0.08); border: 1px solid rgba(37,99,235,0.2); border-radius: 0.75rem; transition: left 200ms ease; }\n  ",[]),B=async(e=!1)=>{try{O(!0);const t=e?{cache:!1,dedupe:!1}:void 0,a=await d.get(`/api/leaves?studentId=${U}`,t);a.success&&q(a.requests||[])}catch(t){}finally{O(!1)}};m.useEffect(()=>{B();const e=()=>B(!0);return window.addEventListener("notificationsUpdated",e),window.addEventListener("marksheetsUpdated",e),()=>{window.removeEventListener("notificationsUpdated",e),window.removeEventListener("marksheetsUpdated",e)}},[]),l({late_arrival:()=>{console.log("ðŸ”” Late arrival notification triggered refresh"),B()}}),s(()=>{B();const e=localStorage.getItem("leaveTabSelection")||"leave";f(e)}),m.useEffect(()=>{const e=()=>{if(!document.hidden){const e=localStorage.getItem("activeTimer");if(e){const t=JSON.parse(e);A(t)}}},t=e=>{if(e.persisted){const e=localStorage.getItem("activeTimer");if(e){const t=JSON.parse(e);A(t)}}};return document.addEventListener("visibilitychange",e),window.addEventListener("pageshow",t),()=>{document.removeEventListener("visibilitychange",e),window.removeEventListener("pageshow",t)}},[]),m.useEffect(()=>{j?(localStorage.setItem("activeTimer",JSON.stringify(j)),sessionStorage.setItem("activeTimer",JSON.stringify(j))):(localStorage.removeItem("activeTimer"),sessionStorage.removeItem("activeTimer"))},[j]),m.useEffect(()=>{localStorage.setItem("leaveTabSelection",x)},[x]),m.useEffect(()=>{if(!j)return;const e=setInterval(()=>{J(e=>e+1)},1e3);return()=>clearInterval(e)},[j]),m.useEffect(()=>{"late"!==x||D||I((()=>{const e=new Date;e.setMinutes(e.getMinutes()+30);const t=e=>`${e}`.padStart(2,"0");return`${t(e.getHours())}:${t(e.getMinutes())}`})())},[x]);const G=y.length,Y=m.useMemo(()=>{if(!C||!_)return 0;const e=new Date(C),t=new Date(_),a=Math.ceil((t-e)/864e5)+1;return isNaN(a)||a<0?0:a},[C,_]);m.useEffect(()=>{if(C&&_){const e=new Date(C);new Date(_)<e&&L(C)}},[C,_]);const H=e=>e?new Date(e).toLocaleString("en-IN",{dateStyle:"medium",timeStyle:"short"}):"-",W=e=>e?new Date(e).toLocaleString("en-IN",{dateStyle:"medium"}):"-";try{window.refreshNotificationCount&&window.refreshNotificationCount()}catch(Q){}const K=e=>{F({title:"Delete leave request?",message:"This will permanently delete your leave request. This action cannot be undone. Continue?",onConfirm:()=>(async e=>{try{const t=await d.del(`/api/leaves?id=${e._id}&action=delete`,{body:{}});t&&t.success?(p("Success","Leave request deleted successfully"),B(!0)):(h("Failed",t.error||"Could not delete request"),console.error("Delete error:",t))}catch(t){h("Error",t.message),console.error("Delete exception:",t)}})(e)})};return n(i,{children:[n("div",{className:"px-4 py-4 w-full max-w-4xl mx-auto",children:[a("style",{children:z}),a(b,{}),a("h1",{className:"text-2xl font-bold mb-4",children:"Leave / Late"}),n("form",{onSubmit:async e=>{if(e.preventDefault(),S(!0),y.trim())if(y.length>200)h("Too long","Reason should be under 200 characters.");else{if("leave"===x){if(!C||!_)return void h("Missing dates","Please provide start and end dates.");if(Y<=0)return void h("Invalid dates","End date must be the same or after start date.")}else if(!D)return void h("Missing time","Please provide expected arrival time.");k(!0);try{const e={type:x,reason:y,regNumber:t.regNumber,phoneNumber:t.phoneNumber};if("leave"===x)e.startDate=C,e.endDate=_;else{const t=(new Date).toISOString().split("T")[0];e.expectedArrivalTime=`${t}T${D}`}const a=await d.post("/api/leaves?action=create",e);a&&a.success?(p("Request submitted",("leave"===x?"Leave":"Late")+" request created"),v(),N(""),T(""),L(""),I(""),f("leave"),B(!0)):h("Failed",a.error||"Could not submit request")}catch(a){h("Error",a.message)}finally{k(!1)}}else h("Missing reason","Please provide a reason.")},className:"bg-white rounded-2xl shadow p-5 mb-6 space-y-5",children:[n("div",{className:"segmented-control relative p-1 rounded-xl bg-white",children:[a("div",{className:"segmented-highlight",style:{left:"leave"===x?"0.25rem":"calc(50% + 0.25rem)",width:"calc(50% - 0.5rem)"}}),n("div",{className:"grid grid-cols-2 gap-0",children:[a("button",{type:"button",onClick:()=>f("leave"),className:"relative z-10 px-4 py-3 rounded-xl text-sm font-bold transition-all "+("leave"===x?"text-blue-700":"text-blue-600 hover:bg-blue-50"),children:"Leave"}),a("button",{type:"button",onClick:()=>f("late"),className:"relative z-10 px-4 py-3 rounded-xl text-sm font-bold transition-all "+("late"===x?"text-blue-700":"text-blue-600 hover:bg-blue-50"),children:"Late"})]})]}),n("div",{children:[a("label",{className:"block text-sm font-semibold mb-1",children:"Reason"}),n("div",{className:"relative",children:[a("input",{value:y,onChange:e=>N(e.target.value),onBlur:()=>S(!0),maxLength:300,className:`w-full border rounded-xl px-3 py-3 pr-14 transition-all ${w&&!y.trim()?"border-red-400 focus:border-red-500":"border-gray-300 focus:border-blue-500"} ${G>160?"pulse-glow":""}`,placeholder:"Briefly explain your reason (e.g., Medical checkup)"}),n("div",{className:"absolute right-3 top-1/2 -translate-y-1/2 text-xs text-gray-500 pointer-events-none",children:[G,"/",200]})]}),w&&!y.trim()&&a("p",{className:"text-xs text-red-600 mt-1",children:"Please provide a reason."})]}),n("div","leave"===x?{className:"grid grid-cols-1 md:grid-cols-2 gap-3",children:[n("div",{children:[a("label",{className:"block text-sm font-semibold mb-1",children:"Start Date"}),a("input",{type:"date",value:C,onChange:e=>T(e.target.value),min:(new Date).toISOString().split("T")[0],className:"w-full border rounded-xl px-3 py-3"})]}),n("div",{children:[a("label",{className:"block text-sm font-semibold mb-1",children:"End Date"}),a("input",{type:"date",value:_,onChange:e=>L(e.target.value),min:C||(new Date).toISOString().split("T")[0],className:"w-full border rounded-xl px-3 py-3"})]}),a("div",{className:"md:col-span-2 text-sm text-gray-600",children:C&&_?`Total days: ${Y}`:"Select dates to compute total days"})]}:{children:[a("label",{className:"block text-sm font-semibold mb-1",children:"Expected Arrival Time"}),n("div",{className:"flex items-center gap-3 mb-1",children:[a("div",{className:"flex-1",children:a("input",{type:"date",value:(new Date).toISOString().split("T")[0],disabled:!0,className:"w-full border rounded-xl px-3 py-3 bg-gray-100 text-gray-600 cursor-not-allowed"})}),a("div",{className:"flex-1",children:a("input",{type:"time",value:D,onChange:e=>I(e.target.value),className:"w-full border rounded-xl px-3 py-3",required:!0})})]}),a("p",{className:"text-xs text-gray-600",children:"Tip: Defaults to +30 minutes from now"})]}),n("div",{className:"flex items-center gap-3",children:[a("button",{disabled:E,className:"px-5 py-3 rounded-xl bg-blue-600 text-white disabled:opacity-50 transition-transform hover:scale-[1.02]",children:"Submit"}),a("button",{type:"button",onClick:()=>{f("leave"),N(""),S(!1),T(""),L(""),I("")},className:"px-4 py-3 rounded-xl border text-gray-700",children:"Clear"})]})]}),n("div",{className:"bg-white rounded-2xl shadow mb-6",children:[a("div",{className:"p-4 border-b",children:a("h2",{className:"font-semibold",children:"Summary"})}),n("div",{className:"p-4 grid grid-cols-1 md:grid-cols-2 gap-3 text-sm",children:[n("div",{children:[a("span",{className:"text-gray-500",children:"Student:"})," ",t.name," (",t.regNumber,")"]}),n("div",{children:[a("span",{className:"text-gray-500",children:"Type:"})," ","leave"===x?"Leave":"Late"]}),"leave"===x?n(i,{children:[n("div",{children:[a("span",{className:"text-gray-500",children:"Period:"})," ",C||"â€”"," â†’ ",_||"â€”"]}),n("div",{children:[a("span",{className:"text-gray-500",children:"Total days:"})," ",Y||"â€”"]})]}):n("div",{children:[a("span",{className:"text-gray-500",children:"Expected arrival:"})," ",D?`Today at ${D}`:"â€”"]}),n("div",{className:"md:col-span-2",children:[a("span",{className:"text-gray-500",children:"Reason:"})," ",y||"â€”"]})]})]}),n("div",{className:"bg-white rounded-2xl shadow",children:[a("div",{className:"p-4 border-b",children:a("h2",{className:"font-semibold",children:"My Requests"})}),M?a("div",{className:"p-4 text-gray-500",children:"Loading..."}):a("ul",{className:"divide-y",children:(()=>{const e=$.filter(e=>e.type===x);return 0===e.length?a("li",{className:"p-4 text-center text-gray-500",children:0===$.length?"No requests yet.":`No ${x} requests found.`}):e.map(e=>{const t="leave"===e.type&&["requested","waiting_for_arrival_confirmation","rejected_by_hod"].includes(e.status),r="leave"===e.type?[...t?[{label:"Delete",icon:"ðŸ—‘ï¸",onClick:()=>K(e),className:"bg-red-600 hover:bg-red-700 text-white",direction:"right",autoTrigger:!0}]:[],..."approved_by_hod"===e.status?[{label:"Download",icon:"ðŸ“„",onClick:()=>{const t=document.createElement("a");t.href=`/api/generate-pdf?type=leave&leaveId=${e._id}`,t.download=`leave-approval-${e._id}.pdf`,document.body.appendChild(t),t.click(),document.body.removeChild(t)},className:"bg-blue-600 hover:bg-blue-700 text-white"}]:[]]:[],l=j?._id===e._id;return a("li",{className:"p-0 hover:bg-gray-50 transition-colors",children:a(o,{actions:r,children:l&&"late"===e.type&&"waiting_for_arrival_confirmation"===e.status?n("div",{className:"px-4 py-4 bg-gradient-to-br from-green-50 to-emerald-50 border-t-2 border-green-300",children:[n("div",{className:"mb-3",children:[a("div",{className:"font-semibold text-gray-900 mb-1",children:"Late Arrival - On the way"}),n("div",{className:"text-sm text-gray-700",children:[a("strong",{children:"Reason:"})," ",e.reason]}),n("div",{className:"text-sm text-gray-600",children:["Expected: ",H(e.expectedArrivalTime)]})]}),n("div",{className:"bg-white rounded-lg p-2 sm:p-3 mb-3 border border-green-200 text-center",children:[a("p",{className:"text-xs text-gray-600 mb-1",children:"You reached at"}),a("p",{className:"text-xl sm:text-2xl md:text-3xl font-bold text-green-600 font-mono leading-tight",children:(new Date).toLocaleTimeString("en-IN",{hour:"2-digit",minute:"2-digit",second:"2-digit"})})]}),a("button",{onClick:()=>(async e=>{try{const t=await d.patch(`/api/leaves?id=${e._id}&action=confirm-arrival`,{});t&&t.success?(p("Success","Your arrival has been confirmed and parent has been notified!"),localStorage.removeItem("activeTimer"),sessionStorage.removeItem("activeTimer"),A(null),J(0),B(!0)):(h("Failed",t.error||"Could not confirm arrival"),console.error("Confirm arrival error:",t))}catch(t){h("Error",t.message),console.error("Confirm arrival exception:",t)}})(e),className:"w-full px-4 py-3 bg-green-600 hover:bg-green-700 text-white font-semibold rounded-lg transition-colors",children:"âœ… I've Reached College"}),a("button",{onClick:()=>{A(null),J(0)},className:"w-full px-4 py-2 mt-2 bg-gray-200 hover:bg-gray-300 text-gray-700 font-semibold rounded-lg transition-colors",children:"Cancel"})]}):n("div",{className:"px-4 py-3",children:[n("div",{className:"flex items-center justify-between mb-2",children:[n("div",{className:"flex-1 pr-4",children:[n("div",{className:"font-medium text-gray-900 flex items-center gap-2",children:["leave"===e.type?"Leave":"Late","late"===e.type&&"waiting_for_arrival_confirmation"===e.status&&a("span",{className:"text-xs font-bold px-2 py-1 rounded-full bg-yellow-100 text-yellow-800",children:"Waiting for you"})]}),n("div",{className:"text-sm text-gray-600",children:["Reason: ",e.reason]}),n("div",{className:"text-sm text-gray-600",children:["Status: ",e.status]}),"leave"===e.type?n("div",{className:"text-sm text-gray-600",children:[W(e.startDate)," â†’ ",W(e.endDate)]}):n("div",{className:"text-sm text-gray-600",children:["Expected: ",H(e.expectedArrivalTime)," ",e.arrivalConfirmedAt?` | Arrived: ${H(e.arrivalConfirmedAt)}`:""]})]}),"leave"===e.type&&"approved_by_hod"===e.status&&a("a",{href:`/api/generate-pdf?type=leave&leaveId=${e._id}`,className:"hidden sm:flex px-3 py-2 text-sm rounded-lg border text-blue-600 border-blue-600 ml-4 flex-shrink-0",children:"Download Letter"})]}),"leave"===e.type&&(t||"approved_by_hod"===e.status)&&n("div",{className:"sm:hidden p-2 bg-gradient-to-r from-blue-50 to-red-50 border-t border-gray-200 rounded-b text-center space-y-1",children:["approved_by_hod"===e.status&&n("p",{className:"text-xs text-gray-600 flex items-center justify-center gap-2",children:[a("span",{children:"ðŸ‘ˆ"}),a("span",{className:"font-medium",children:"Swipe left to download"})]}),t&&n("p",{className:"text-xs text-gray-600 flex items-center justify-center gap-2",children:[a("span",{children:"ðŸ‘‰"}),a("span",{className:"font-medium",children:"Swipe right to delete"})]})]}),"late"===e.type&&"waiting_for_arrival_confirmation"===e.status&&a("div",{className:"p-3 bg-yellow-50 border-t border-yellow-100 rounded-b text-center",children:a("button",{onClick:()=>{A(e),J(0)},className:"w-full px-3 py-2 text-sm rounded-lg bg-green-100 text-green-700 hover:bg-green-200",children:"â± Start Timer"})})]})})},e._id)})})()})]})]}),P&&a(g,{open:!0,title:P.title,description:P.message,confirmLabel:"Delete",cancelLabel:"Cancel",onConfirm:()=>{P.onConfirm(),F(null)},onCancel:()=>F(null)})]})})}}});
