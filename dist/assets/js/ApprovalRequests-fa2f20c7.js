import{u as de,d as ce,e as ue,a as P,j as t,b as s,F as pe,S as me}from"./index-a36099b1.js";import{r as o,u as ge}from"./react-vendor-ad4d5528.js";import{R as he}from"./RefreshButton-4223bdd0.js";import{u as fe}from"./Confetti-9ac51eaf.js";import{H as be}from"./ContextualHelp-41fe2753.js";import{u as xe,P as ye}from"./usePullToRefresh-291be9c1.js";function De(){const{showSuccess:m,showError:h,showWarning:D}=de(),{celebrate:f,ConfettiContainer:K}=fe(),[r,M]=o.useState(()=>{try{const e=localStorage.getItem("auth");return e?JSON.parse(e):null}catch(e){return console.error("Failed to parse auth data:",e),null}}),[w,$]=o.useState([]),[B,v]=o.useState(!0),[_,Z]=o.useState("all"),[u,O]=o.useState({open:!1,type:null,marksheet:null,anchorRect:null}),[ee,Y]=o.useState(!1),[L,N]=o.useState(""),[z,H]=o.useState(""),[C,G]=o.useState(!1),[U,W]=o.useState(!1),[te,F]=o.useState([]),V={AI_DS:"AI & DS",CSE:"CSE",IT:"IT",ECE:"ECE",EEE:"EEE",MECH:"MECH",CIVIL:"CIVIL",HNS:"H&S"},J={CSE:"bg-blue-100 text-blue-800",AI_DS:"bg-indigo-100 text-indigo-800",ECE:"bg-teal-100 text-teal-800",IT:"bg-green-100 text-green-800",MECH:"bg-amber-100 text-amber-800",CIVIL:"bg-red-100 text-red-800",EEE:"bg-purple-100 text-purple-800",HNS:"bg-yellow-50 text-yellow-800"},l=ge(),g=async()=>{await b(),m("ðŸ”„ Refreshed","Approval requests updated")},{isPulling:S,isRefreshing:I,pullDistance:se,containerRef:E,threshold:T}=xe(g,{enabled:!0,threshold:80}),j=async()=>{if(r)try{const e=new URLSearchParams({department:r.department,type:"leave"}),a=await P.get("/api/leaves?".concat(e.toString()));if(a.success){const n=(a.requests||[]).filter(i=>i.status==="requested");F(n)}else F([])}catch(e){console.error("Error fetching leave requests:",e),F([])}};o.useEffect(()=>{(r==null?void 0:r.role)==="hod"?(b(),j()):v(!1)},[r]),ce({leave_request:()=>{console.log("ðŸ”” Leave request notification triggered refresh"),j()},leave_approval:()=>{console.log("ðŸ”” Leave approval notification triggered refresh"),j()},marksheet_approval:()=>{console.log("ðŸ”” Marksheet approval notification triggered refresh"),b()},dispatch_request:()=>{console.log("ðŸ”” Dispatch request notification triggered refresh"),b()}}),ue(()=>{b(),j()});const b=async()=>{if(r){v(!0);try{let e;r.department==="HNS"?(console.log("[ApprovalRequests] HNS HOD detected â€” fetching Year I pending requests across departments"),e=await P.get("/api/marksheets?year=I&status=dispatch_requested")):(console.log("[ApprovalRequests] Fetching with department:",r.department),e=await P.get("/api/marksheets?department=".concat(r.department,"&status=dispatch_requested"))),console.log("[ApprovalRequests] Response:",e),e&&e.success?$(e.marksheets):$([])}catch(e){console.error("Error fetching pending requests:",e),$([])}finally{v(!1)}}},A=async()=>{try{if(r!=null&&r.eSignature)return r;const e=(r==null?void 0:r._id)||(r==null?void 0:r.id);if(!e)return null;const a=await P.get("/api/users?action=profile&userId=".concat(e));if(a!=null&&a.success&&a.user){const n={...r,...a.user};try{localStorage.setItem("auth",JSON.stringify(n))}catch(i){}return M(n),n}}catch(e){console.error("[ApprovalRequests] Failed to refresh HOD profile:",e)}return r},Q=async()=>{W(!0);try{await b()}finally{W(!1)}},k=(e,a,n)=>{var c;const i=typeof window<"u",p=(c=e==null?void 0:e.currentTarget)==null?void 0:c.getBoundingClientRect(),d=p&&i?{top:p.top+window.scrollY,left:p.left+window.scrollX,width:p.width,height:p.height}:null;N(""),O({open:!0,type:n,marksheet:a,anchorRect:d})},X=()=>{O({open:!1,type:null,marksheet:null,anchorRect:null}),N("")},ne=async({comments:e})=>{var a,n;if(!(!u.marksheet||!u.type))try{Y(!0);const i=await A();if(!(i!=null&&i.eSignature)){h("Signature Missing","Please add your signature in Settings before approving requests"),Y(!1);return}const p=r._id||r.id,d=await P.post("/api/marksheets?action=hod-response",{marksheetId:u.marksheet._id,hodId:p,response:u.type,comments:e});if(!d||!d.success)throw new Error((d==null?void 0:d.error)||"Failed to submit response");const c=u.type==="approved"?"approved":"rejected",q=((n=(a=u.marksheet)==null?void 0:a.studentDetails)==null?void 0:n.name)||"Student";H("Dispatch request ".concat(c," successfully.")),u.type==="approved"?m("âœ“ Approved","Dispatch approved for ".concat(q)):D("Request Rejected","Dispatch rejected for ".concat(q)),X(),await b()}catch(i){N(i.message||"Unexpected error"),h("Action Failed",i.message||"Could not process the request")}finally{Y(!1)}},re=async e=>{const a=R.filter(n=>n.status==="dispatch_requested");if(a.length===0){H("No pending requests available for bulk ".concat(e,"."));return}try{const n=await A();if(!(n!=null&&n.eSignature)){h("Signature Missing","Please add your signature in Settings before approving requests");return}G(!0),N("");const i=r._id||r.id,p=a.map(x=>P.post("/api/marksheets?action=hod-response",{marksheetId:x._id,hodId:i,response:e,comments:""}).then(y=>y).catch(y=>({success:!1,error:y.message}))),d=await Promise.all(p),c=d.filter(x=>x.success).length,q=d.length-c;if(c>0){const x="Successfully ".concat(e," ").concat(c," request").concat(c>1?"s":"",".").concat(q>0?" ".concat(q," failed."):"");H(x),m("Bulk ".concat(e.charAt(0).toUpperCase()+e.slice(1)),"".concat(c,"/").concat(d.length," requests processed successfully")),q===0&&f()}else{const x="Failed to ".concat(e.slice(0,-1)," any requests. Please try again.");N(x),h("Bulk Action Failed",x)}await b()}catch(n){N(n.message||"Failed to perform bulk ".concat(e))}finally{G(!1)}},ae=o.useMemo(()=>[{id:"all",label:"All",count:w.length},{id:"dispatch_requested",label:"Pending",count:w.filter(e=>e.status==="dispatch_requested").length}],[w]),R=o.useMemo(()=>(_==="all"?w:w.filter(a=>a.status===_)).sort((a,n)=>{var d,c;const i=(((d=a.studentDetails)==null?void 0:d.regNumber)||"").toString().toLowerCase(),p=(((c=n.studentDetails)==null?void 0:c.regNumber)||"").toString().toLowerCase();return i.localeCompare(p,void 0,{numeric:!0,sensitivity:"base"})}),[w,_]),oe={dispatch_requested:"bg-yellow-100 text-yellow-800",approved_by_hod:"bg-green-100 text-green-800",rejected_by_hod:"bg-red-100 text-red-800",dispatched:"bg-purple-100 text-purple-800"},ie={dispatch_requested:"â³",approved_by_hod:"âœ…",rejected_by_hod:"â›”",dispatched:"ðŸ“¤"},le=(e={})=>{const a=(e.year||"").toString(),n=(e.section||"").toString();return!a&&!n?"N/A":n?a?"".concat(a,"-").concat(n):n:a};return!r||r.role!=="hod"?t("div",{className:"min-h-screen bg-gradient-to-br from-slate-50 via-blue-50 to-indigo-50 flex items-center justify-center",children:s("div",{className:"glass-card p-8 rounded-3xl text-center",children:[t("h1",{className:"text-2xl font-bold text-gray-900 mb-4",children:"Access Denied"}),t("p",{className:"text-gray-600",children:"Only HODs can approve dispatch requests."})]})}):s("div",{ref:E,className:"min-h-screen bg-gradient-to-br from-slate-50 via-blue-50 to-indigo-50",children:[t(ye,{pullDistance:se,threshold:T,isRefreshing:I}),t("div",{className:"container mx-auto px-4 sm:px-6 lg:px-8 py-8",children:s("div",{className:"max-w-6xl mx-auto",children:[s("div",{className:"text-center mb-8",children:[t("h1",{className:"text-4xl sm:text-5xl lg:text-6xl font-black text-gray-900 mb-4",children:"Approval Requests"}),s("p",{className:"text-lg text-gray-600 max-w-3xl mx-auto",children:["Review and approve dispatch requests for ",r.department," Department"]})]}),te.length>0&&t("div",{className:"mb-6 p-4 bg-blue-50 border border-blue-200 rounded-xl",children:s("p",{className:"text-sm text-blue-700",children:["ðŸ’¡ ",t("strong",{children:"Note:"})," Leave request approvals have been moved to your notification inbox. Click the ðŸ”” bell icon to review leave requests alongside staff account approvals."]})}),t("div",{className:"glass-card p-4 sm:p-6 md:p-8 rounded-2xl md:rounded-3xl mb-8",children:B?s("div",{className:"text-center py-12",children:[t("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto mb-4"}),t("p",{className:"text-gray-600",children:"Loading pending requests..."})]}):w.length===0?s("div",{className:"text-center py-12",children:[t("svg",{className:"w-16 h-16 text-gray-400 mx-auto mb-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:t("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"})}),t("h3",{className:"text-xl font-semibold text-gray-900 mb-2",children:"No pending requests"}),t("p",{className:"text-gray-600",children:"All dispatch requests have been processed"})]}):s(pe,{children:[t("div",{className:"flex flex-wrap items-center gap-3 mb-6",children:ae.map(e=>s("button",{onClick:()=>Z(e.id),className:"px-4 py-2 rounded-full text-sm font-medium border transition-all duration-200 ".concat(_===e.id?"bg-blue-600 text-white border-blue-600":"bg-white text-gray-700 border-gray-200 hover:border-blue-400"),children:[e.label,t("span",{className:"ml-2 inline-flex items-center justify-center px-2 py-0.5 rounded-full text-xs font-semibold ".concat(_===e.id?"bg-white/25 text-white":"bg-gray-100 text-gray-700"),children:e.count})]},e.id))}),z&&t("div",{className:"mb-6 rounded-xl border border-green-200 bg-green-50 px-4 py-3 text-sm text-green-800",children:z}),L&&t("div",{className:"mb-6 rounded-xl border border-red-200 bg-red-50 px-4 py-3 text-sm text-red-800",children:L}),s("div",{className:"mb-6 p-3 sm:p-4 bg-gradient-to-r from-blue-50 to-indigo-50 rounded-xl border border-blue-100",children:[s("div",{className:"flex items-start justify-between gap-4 mb-3",children:[t("div",{className:"flex items-center gap-2",children:s("div",{children:[s("div",{className:"flex items-center gap-2",children:[t("h3",{className:"text-sm font-semibold text-gray-900",children:"Bulk Actions"}),t(be,{content:"Quickly approve or reject all pending dispatch requests at once."})]}),s("p",{className:"text-xs text-gray-600",children:[R.filter(e=>e.status==="dispatch_requested").length," pending requests available"]})]})}),t(he,{isLoading:U,onClick:Q})]}),s("div",{className:"grid grid-cols-1 sm:grid-cols-2 gap-2 sm:gap-3",children:[t("button",{onClick:()=>re("approved"),disabled:C||R.filter(e=>e.status==="dispatch_requested").length===0,className:"px-3 sm:px-4 py-2 rounded-lg font-medium text-white text-xs sm:text-sm transition-all duration-200 shadow-sm hover:shadow focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-1 ".concat(C||R.filter(e=>e.status==="dispatch_requested").length===0?"bg-gray-300 cursor-not-allowed":"bg-green-600 hover:bg-green-700"),children:s("span",{className:"flex items-center justify-center gap-1",children:[t("span",{children:"âœ…"}),t("span",{children:C?"Processing...":"Approve All"})]})}),t("button",{onClick:()=>re("rejected"),disabled:C||R.filter(e=>e.status==="dispatch_requested").length===0,className:"px-3 sm:px-4 py-2 rounded-lg font-medium text-white text-xs sm:text-sm transition-all duration-200 shadow-sm hover:shadow focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-1 ".concat(C||R.filter(e=>e.status==="dispatch_requested").length===0?"bg-gray-300 cursor-not-allowed":"bg-red-600 hover:bg-red-700"),children:s("span",{className:"flex items-center justify-center gap-1",children:[t("span",{children:"â›”"}),t("span",{children:C?"Processing...":"Reject All"})]})})]})]}),t("div",{className:"space-y-4",children:R.map(e=>{var n,i,p,d,c,q,x;return t(me,{actions:[{label:"Details",icon:"ðŸ‘ï¸",className:"border-slate-300 text-slate-600 hover:border-slate-500 hover:bg-slate-50",onClick:()=>l("/marksheets/".concat(e._id||e.marksheetId))},{label:"Reject",icon:"âŒ",className:"border-red-300 text-red-600 hover:border-red-500 hover:bg-red-50",onClick:y=>k(y,e,"rejected")},{label:"Approve",icon:"âœ…",className:"border-green-300 text-green-600 hover:border-green-500 hover:bg-green-50",onClick:y=>k(y,e,"approved")}],children:s("div",{className:"bg-white",children:[s("div",{className:"p-4 sm:p-6 pb-3 sm:pb-4",children:[s("div",{className:"flex items-start justify-between mb-3 gap-2",children:[s("div",{className:"flex-1 min-w-0",children:[t("h3",{className:"text-lg sm:text-xl font-bold text-gray-900 mb-1 truncate",children:(n=e.studentDetails)==null?void 0:n.name}),s("p",{className:"text-xs sm:text-sm text-gray-600 flex items-center gap-2",children:[s("span",{children:[(i=e.studentDetails)==null?void 0:i.regNumber," â€¢ ",le(e.studentDetails)]}),((p=e.studentDetails)==null?void 0:p.department)&&t("span",{className:"inline-flex items-center gap-1 rounded-full px-2 py-0.5 text-[10px] font-semibold uppercase ".concat(J[e.studentDetails.department]||"bg-gray-100 text-gray-800"),children:V[(d=e.studentDetails)==null?void 0:d.department]||(((c=e.studentDetails)==null?void 0:c.department)||"").toUpperCase()})]})]}),s("span",{className:"px-2 py-1 sm:px-3 sm:py-1.5 rounded-full text-xs font-semibold uppercase tracking-wide flex items-center gap-1 whitespace-nowrap ".concat(oe[e.status]||"bg-yellow-100 text-yellow-800"),children:[t("span",{className:"text-xs sm:text-sm",children:ie[e.status]||"ðŸ“„"}),t("span",{className:"text-xs",children:(e.status||"").replace(/_/g," ")})]})]}),s("div",{className:"grid grid-cols-2 lg:grid-cols-4 gap-3 sm:gap-4 md:gap-6 text-xs sm:text-sm",children:[s("div",{children:[t("p",{className:"text-gray-500 mb-1",children:"Staff:"}),t("p",{className:"font-medium text-gray-900 truncate",children:e.staffName||"demo staff"})]}),s("div",{children:[t("p",{className:"text-gray-500 mb-1",children:"Parent Phone:"}),t("p",{className:"font-medium text-gray-900",children:((q=e.studentDetails)==null?void 0:q.parentPhoneNumber)||"â€”"})]}),s("div",{children:[t("p",{className:"text-gray-500 mb-1",children:"Exam Date:"}),t("p",{className:"font-medium text-gray-900",children:e.examinationDate?new Date(e.examinationDate).toLocaleDateString("en-US",{month:"short",year:"numeric"}):"â€”"})]}),s("div",{children:[t("p",{className:"text-gray-500 mb-1",children:"Subjects:"}),t("p",{className:"font-medium text-gray-900",children:((x=e.subjects)==null?void 0:x.length)||0})]})]})]}),t("div",{className:"border-t border-gray-100"}),t("div",{className:"hidden sm:block p-4 sm:p-6 pt-3 sm:pt-4 bg-gray-50",children:s("div",{className:"grid grid-cols-4 gap-3",children:[t("button",{onClick:y=>k(y,e,"approved"),className:"px-4 py-2.5 bg-green-600 hover:bg-green-700 text-white text-sm font-medium rounded-lg transition-all duration-200 shadow-sm hover:shadow focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-1",children:"Approve Dispatch"}),t("button",{onClick:y=>k(y,e,"rejected"),className:"px-4 py-2.5 bg-red-600 hover:bg-red-700 text-white text-sm font-medium rounded-lg transition-all duration-200 shadow-sm hover:shadow focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-1",children:"Reject Request"}),t("button",{onClick:()=>l("/marksheets/".concat(e._id||e.marksheetId)),className:"px-4 py-2.5 bg-white hover:bg-gray-50 text-gray-700 text-sm font-medium rounded-lg border border-gray-300 transition-all duration-200 shadow-sm hover:shadow focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-1",children:"View Details"})]})}),t("div",{className:"sm:hidden p-3 bg-gradient-to-r from-blue-50 to-indigo-50 border-t border-blue-100",children:s("p",{className:"text-xs text-center text-gray-600 flex items-center justify-center gap-2",children:[t("span",{children:"ðŸ‘ˆ"}),t("span",{className:"font-medium",children:"Swipe left for actions"})]})})]})},e._id)})})]})})]})}),t(we,{open:u.open,type:u.type,marksheet:u.marksheet,anchorRect:u.anchorRect,onClose:X,onSubmit:ne,loading:ee,error:L}),t(K,{})]})}function we({open:m,type:h,marksheet:D,anchorRect:f,onClose:K,onSubmit:r,loading:M,error:w}){var V,J;const[$,B]=o.useState(""),[v,_]=o.useState(()=>typeof window<"u"?window.innerWidth<640:!0),[Z,u]=o.useState(m);if(o.useEffect(()=>{const l=()=>_(window.innerWidth<640);return window.addEventListener("resize",l),()=>window.removeEventListener("resize",l)},[]),o.useEffect(()=>{if(m)u(!0);else{const l=setTimeout(()=>u(!1),120);return()=>clearTimeout(l)}},[m]),o.useEffect(()=>{!m||!D||B("")},[m,h,D]),!Z||!D)return null;const O=h==="approved"?"Approve dispatch request":"Reject dispatch request",ee=l=>{l.preventDefault();const g={comments:$.trim()||void 0};try{N(!0)}catch(S){}r(g)},L=(()=>{if(typeof window>"u")return{width:"100%",maxWidth:"100%",borderRadius:"24px 24px 0 0",position:"fixed",left:0,right:0,bottom:0,margin:"0 auto"};if(["rejected","approved"].includes(h)){const A=Math.min(420,window.innerWidth-32),Q=window.innerWidth,k=Math.max(16,Math.min((Q-A)/2,Q-A-16)),X=Math.max(window.scrollY+16,window.scrollY+80);return{width:A,position:"absolute",left:k,top:X}}if(v||!f)return{width:"100%",maxWidth:"100%",borderRadius:"24px 24px 0 0",position:"fixed",left:0,right:0,bottom:0,margin:"0 auto"};const g=16,S=420,I=window.innerWidth,se=window.innerHeight;if(h==="rejected"||h==="approved"){const b=Math.max(g,Math.min((I-S)/2,I-S-g)),A=Math.max(window.scrollY+g,window.scrollY+120);return{width:S,position:"absolute",left:b,top:A}}let E=f.left+f.width+12;E+S>I-g&&(E=f.left-S-12,E<g&&(E=Math.min(Math.max(g,f.left+f.width/2-S/2),I-S-g)));let T=f.top+f.height+12;const j=window.scrollY+se-24-380;return T>j&&(T=Math.max(window.scrollY+g,f.top-380-12)),{width:S,position:"absolute",left:E,top:T}})(),N=(l=!1)=>{l&&u(!1);try{K()}catch(g){}},z=m?"opacity-100":"opacity-0",H=m?"":"pointer-events-none",C="glass-card w-full p-6 shadow-2xl transition-all duration-100",G=m?"translate-y-0 rounded-t-2xl":"translate-y-full rounded-t-2xl",U=m?"translate-y-0 scale-100":"translate-y-2 scale-95",W=["rejected","approved"].includes(h),te=v&&W?"rounded-xl shadow-lg":"",F="".concat(C," ").concat(te," ").concat(W?U:v?G:U);return t("div",{className:"fixed inset-0 z-50 flex items-start justify-center bg-black/40 px-4 py-6 sm:py-10 ".concat(z," ").concat(H),onClick:l=>{l.target===l.currentTarget&&N(!1)},style:{transition:"opacity 100ms cubic-bezier(0.2,0,0,1)"},children:s("div",{className:F,style:L,children:[s("div",{className:"mb-4",children:[t("h3",{className:"text-xl font-semibold text-gray-900",children:O}),s("p",{className:"text-sm text-gray-600 mt-1",children:[(V=D.studentDetails)==null?void 0:V.name," â€¢ ",(J=D.studentDetails)==null?void 0:J.regNumber]})]}),s("form",{onSubmit:ee,className:"space-y-4",children:[s("div",{children:[t("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Comments (optional)"}),t("textarea",{value:$,onChange:l=>B(l.target.value),rows:4,className:"w-full rounded-lg border border-gray-200 px-3 py-2 focus:border-blue-500 focus:outline-none",placeholder:h==="rejected"?"Let the staff know the reason for rejection":"Add any notes for the staff member"})]}),w&&t("div",{className:"rounded-lg border border-red-200 bg-red-50 px-3 py-2 text-sm text-red-700",children:w}),s("div",{className:"flex ".concat(v?"flex-col-reverse gap-2":"justify-end gap-3"," pt-2"),children:[t("button",{type:"button",onClick:()=>N(!0),className:"px-4 py-2 rounded-lg border border-gray-200 text-gray-700 hover:bg-gray-100 ".concat(v?"w-full text-center":""),children:"Cancel"}),t("button",{type:"submit",disabled:M,className:"px-5 py-2 rounded-lg text-white ".concat(M?"bg-blue-300 cursor-wait":"bg-blue-600 hover:bg-blue-700"," ").concat(v?"w-full text-center":""),children:M?"Saving...":"Confirm"})]})]})]})})}export{De as default};
