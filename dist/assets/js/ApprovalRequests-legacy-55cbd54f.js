System.register(["./index-legacy-9eeb83db.js","./react-vendor-legacy-4587369d.js","./RefreshButton-legacy-e696f52d.js","./Confetti-legacy-f2d6528f.js","./ContextualHelp-legacy-d4a3ae1d.js","./usePullToRefresh-legacy-3141b38e.js"],function(e,t){"use strict";var r,s,a,n,i,l,o,d,c,u,p,m,h,g,f;return{setters:[e=>{r=e.u,s=e.d,a=e.e,n=e.a,i=e.j,l=e.b,o=e.F,d=e.S},e=>{c=e.r,u=e.u},e=>{p=e.R},e=>{m=e.u},e=>{h=e.H},e=>{g=e.u,f=e.P}],execute:function(){function t({open:e,type:t,marksheet:r,anchorRect:s,onClose:a,onSubmit:n,loading:o,error:d}){const[u,p]=c.useState(""),[m,h]=c.useState(()=>"undefined"==typeof window||window.innerWidth<640),[g,f]=c.useState(e);if(c.useEffect(()=>{const e=()=>h(window.innerWidth<640);return window.addEventListener("resize",e),()=>window.removeEventListener("resize",e)},[]),c.useEffect(()=>{if(!e){const e=setTimeout(()=>f(!1),120);return()=>clearTimeout(e)}f(!0)},[e]),c.useEffect(()=>{e&&r&&p("")},[e,t,r]),!g||!r)return null;const x="approved"===t?"Approve dispatch request":"Reject dispatch request",b=(()=>{if("undefined"==typeof window)return{width:"100%",maxWidth:"100%",borderRadius:"24px 24px 0 0",position:"fixed",left:0,right:0,bottom:0,margin:"0 auto"};if(["rejected","approved"].includes(t)){const e=16,t=Math.min(420,window.innerWidth-2*e),r=window.innerWidth;return{width:t,position:"absolute",left:Math.max(e,Math.min((r-t)/2,r-t-e)),top:Math.max(window.scrollY+e,window.scrollY+80)}}if(m||!s)return{width:"100%",maxWidth:"100%",borderRadius:"24px 24px 0 0",position:"fixed",left:0,right:0,bottom:0,margin:"0 auto"};const e=16,r=420,a=window.innerWidth,n=window.innerHeight;if("rejected"===t||"approved"===t)return{width:r,position:"absolute",left:Math.max(e,Math.min((a-r)/2,a-r-e)),top:Math.max(window.scrollY+e,window.scrollY+120)};let i=s.left+s.width+12;i+r>a-e&&(i=s.left-r-12,i<e&&(i=Math.min(Math.max(e,s.left+s.width/2-210),a-r-e)));let l=s.top+s.height+12;return l>window.scrollY+n-24-380&&(l=Math.max(window.scrollY+e,s.top-380-12)),{width:r,position:"absolute",left:i,top:l}})(),y=(e=!1)=>{e&&f(!1);try{a()}catch(t){}},v=e?"opacity-100":"opacity-0",w=e?"":"pointer-events-none",N=e?"translate-y-0 rounded-t-2xl":"translate-y-full rounded-t-2xl",S=e?"translate-y-0 scale-100":"translate-y-2 scale-95",k=["rejected","approved"].includes(t);return i("div",{className:`fixed inset-0 z-50 flex items-start justify-center bg-black/40 px-4 py-6 sm:py-10 ${v} ${w}`,onClick:e=>{e.target===e.currentTarget&&y(!1)},style:{transition:"opacity 100ms cubic-bezier(0.2,0,0,1)"},children:l("div",{className:`glass-card w-full p-6 shadow-2xl transition-all duration-100 ${m&&k?"rounded-xl shadow-lg":""} ${k?S:m?N:S}`,style:b,children:[l("div",{className:"mb-4",children:[i("h3",{className:"text-xl font-semibold text-gray-900",children:x}),l("p",{className:"text-sm text-gray-600 mt-1",children:[r.studentDetails?.name," â€¢ ",r.studentDetails?.regNumber]})]}),l("form",{onSubmit:e=>{e.preventDefault();const t={comments:u.trim()||void 0};try{y(!0)}catch(r){}n(t)},className:"space-y-4",children:[l("div",{children:[i("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Comments (optional)"}),i("textarea",{value:u,onChange:e=>p(e.target.value),rows:4,className:"w-full rounded-lg border border-gray-200 px-3 py-2 focus:border-blue-500 focus:outline-none",placeholder:"rejected"===t?"Let the staff know the reason for rejection":"Add any notes for the staff member"})]}),d&&i("div",{className:"rounded-lg border border-red-200 bg-red-50 px-3 py-2 text-sm text-red-700",children:d}),l("div",{className:`flex ${m?"flex-col-reverse gap-2":"justify-end gap-3"} pt-2`,children:[i("button",{type:"button",onClick:()=>y(!0),className:"px-4 py-2 rounded-lg border border-gray-200 text-gray-700 hover:bg-gray-100 "+(m?"w-full text-center":""),children:"Cancel"}),i("button",{type:"submit",disabled:o,className:`px-5 py-2 rounded-lg text-white ${o?"bg-blue-300 cursor-wait":"bg-blue-600 hover:bg-blue-700"} ${m?"w-full text-center":""}`,children:o?"Saving...":"Confirm"})]})]})]})})}e("default",function(){const{showSuccess:e,showError:x,showWarning:b}=r(),{celebrate:y,ConfettiContainer:v}=m(),[w,N]=c.useState(()=>{try{const e=localStorage.getItem("auth");return e?JSON.parse(e):null}catch(e){return console.error("Failed to parse auth data:",e),null}}),[S,k]=c.useState([]),[q,C]=c.useState(!0),[j,D]=c.useState("all"),[_,E]=c.useState({open:!1,type:null,marksheet:null,anchorRect:null}),[R,$]=c.useState(!1),[A,I]=c.useState(""),[M,L]=c.useState(""),[H,P]=c.useState(!1),[F,W]=c.useState(!1),[T,Y]=c.useState([]),B={AI_DS:"AI & DS",CSE:"CSE",IT:"IT",ECE:"ECE",EEE:"EEE",MECH:"MECH",CIVIL:"CIVIL",HNS:"H&S"},O={CSE:"bg-blue-100 text-blue-800",AI_DS:"bg-indigo-100 text-indigo-800",ECE:"bg-teal-100 text-teal-800",IT:"bg-green-100 text-green-800",MECH:"bg-amber-100 text-amber-800",CIVIL:"bg-red-100 text-red-800",EEE:"bg-purple-100 text-purple-800",HNS:"bg-yellow-50 text-yellow-800"},z=u(),{isPulling:U,isRefreshing:V,pullDistance:J,containerRef:Q,threshold:X}=g(async()=>{await K(),e("ðŸ”„ Refreshed","Approval requests updated")},{enabled:!0,threshold:80}),G=async()=>{if(w)try{const e=new URLSearchParams({department:w.department,type:"leave"}),t=await n.get(`/api/leaves?${e.toString()}`);if(t.success){const e=(t.requests||[]).filter(e=>"requested"===e.status);Y(e)}else Y([])}catch(e){console.error("Error fetching leave requests:",e),Y([])}};c.useEffect(()=>{"hod"===w?.role?(K(),G()):C(!1)},[w]),s({leave_request:()=>{console.log("ðŸ”” Leave request notification triggered refresh"),G()},leave_approval:()=>{console.log("ðŸ”” Leave approval notification triggered refresh"),G()},marksheet_approval:()=>{console.log("ðŸ”” Marksheet approval notification triggered refresh"),K()},dispatch_request:()=>{console.log("ðŸ”” Dispatch request notification triggered refresh"),K()}}),a(()=>{K(),G()});const K=async()=>{if(w){C(!0);try{let e;"HNS"===w.department?(console.log("[ApprovalRequests] HNS HOD detected â€” fetching Year I pending requests across departments"),e=await n.get("/api/marksheets?year=I&status=dispatch_requested")):(console.log("[ApprovalRequests] Fetching with department:",w.department),e=await n.get(`/api/marksheets?department=${w.department}&status=dispatch_requested`)),console.log("[ApprovalRequests] Response:",e),e&&e.success?k(e.marksheets):k([])}catch(e){console.error("Error fetching pending requests:",e),k([])}finally{C(!1)}}},Z=async()=>{try{if(w?.eSignature)return w;const t=w?._id||w?.id;if(!t)return null;const r=await n.get(`/api/users?action=profile&userId=${t}`);if(r?.success&&r.user){const t={...w,...r.user};try{localStorage.setItem("auth",JSON.stringify(t))}catch(e){}return N(t),t}}catch(e){console.error("[ApprovalRequests] Failed to refresh HOD profile:",e)}return w},ee=(e,t,r)=>{const s="undefined"!=typeof window,a=e?.currentTarget?.getBoundingClientRect(),n=a&&s?{top:a.top+window.scrollY,left:a.left+window.scrollX,width:a.width,height:a.height}:null;I(""),E({open:!0,type:r,marksheet:t,anchorRect:n})},te=()=>{E({open:!1,type:null,marksheet:null,anchorRect:null}),I("")},re=async t=>{const r=ae.filter(e=>"dispatch_requested"===e.status);if(0!==r.length)try{const s=await Z();if(!s?.eSignature)return void x("Signature Missing","Please add your signature in Settings before approving requests");P(!0),I("");const a=w._id||w.id,i=r.map(e=>n.post("/api/marksheets?action=hod-response",{marksheetId:e._id,hodId:a,response:t,comments:""}).then(e=>e).catch(e=>({success:!1,error:e.message}))),l=await Promise.all(i),o=l.filter(e=>e.success).length,d=l.length-o;if(o>0)L(`Successfully ${t} ${o} request${o>1?"s":""}.${d>0?` ${d} failed.`:""}`),e(`Bulk ${t.charAt(0).toUpperCase()+t.slice(1)}`,`${o}/${l.length} requests processed successfully`),0===d&&y();else{const e=`Failed to ${t.slice(0,-1)} any requests. Please try again.`;I(e),x("Bulk Action Failed",e)}await K()}catch(s){I(s.message||`Failed to perform bulk ${t}`)}finally{P(!1)}else L(`No pending requests available for bulk ${t}.`)},se=c.useMemo(()=>[{id:"all",label:"All",count:S.length},{id:"dispatch_requested",label:"Pending",count:S.filter(e=>"dispatch_requested"===e.status).length}],[S]),ae=c.useMemo(()=>("all"===j?S:S.filter(e=>e.status===j)).sort((e,t)=>{const r=(e.studentDetails?.regNumber||"").toString().toLowerCase(),s=(t.studentDetails?.regNumber||"").toString().toLowerCase();return r.localeCompare(s,void 0,{numeric:!0,sensitivity:"base"})}),[S,j]),ne={dispatch_requested:"bg-yellow-100 text-yellow-800",approved_by_hod:"bg-green-100 text-green-800",rejected_by_hod:"bg-red-100 text-red-800",dispatched:"bg-purple-100 text-purple-800"},ie={dispatch_requested:"â³",approved_by_hod:"âœ…",rejected_by_hod:"â›”",dispatched:"ðŸ“¤"},le=(e={})=>{const t=(e.year||"").toString(),r=(e.section||"").toString();return t||r?r?t?`${t}-${r}`:r:t:"N/A"};return w&&"hod"===w.role?l("div",{ref:Q,className:"min-h-screen bg-gradient-to-br from-slate-50 via-blue-50 to-indigo-50",children:[i(f,{pullDistance:J,threshold:X,isRefreshing:V}),i("div",{className:"container mx-auto px-4 sm:px-6 lg:px-8 py-8",children:l("div",{className:"max-w-6xl mx-auto",children:[l("div",{className:"text-center mb-8",children:[i("h1",{className:"text-4xl sm:text-5xl lg:text-6xl font-black text-gray-900 mb-4",children:"Approval Requests"}),l("p",{className:"text-lg text-gray-600 max-w-3xl mx-auto",children:["Review and approve dispatch requests for ",w.department," Department"]})]}),T.length>0&&i("div",{className:"mb-6 p-4 bg-blue-50 border border-blue-200 rounded-xl",children:l("p",{className:"text-sm text-blue-700",children:["ðŸ’¡ ",i("strong",{children:"Note:"})," Leave request approvals have been moved to your notification inbox. Click the ðŸ”” bell icon to review leave requests alongside staff account approvals."]})}),i("div",{className:"glass-card p-4 sm:p-6 md:p-8 rounded-2xl md:rounded-3xl mb-8",children:q?l("div",{className:"text-center py-12",children:[i("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto mb-4"}),i("p",{className:"text-gray-600",children:"Loading pending requests..."})]}):0===S.length?l("div",{className:"text-center py-12",children:[i("svg",{className:"w-16 h-16 text-gray-400 mx-auto mb-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:i("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"})}),i("h3",{className:"text-xl font-semibold text-gray-900 mb-2",children:"No pending requests"}),i("p",{className:"text-gray-600",children:"All dispatch requests have been processed"})]}):l(o,{children:[i("div",{className:"flex flex-wrap items-center gap-3 mb-6",children:se.map(e=>l("button",{onClick:()=>D(e.id),className:"px-4 py-2 rounded-full text-sm font-medium border transition-all duration-200 "+(j===e.id?"bg-blue-600 text-white border-blue-600":"bg-white text-gray-700 border-gray-200 hover:border-blue-400"),children:[e.label,i("span",{className:"ml-2 inline-flex items-center justify-center px-2 py-0.5 rounded-full text-xs font-semibold "+(j===e.id?"bg-white/25 text-white":"bg-gray-100 text-gray-700"),children:e.count})]},e.id))}),M&&i("div",{className:"mb-6 rounded-xl border border-green-200 bg-green-50 px-4 py-3 text-sm text-green-800",children:M}),A&&i("div",{className:"mb-6 rounded-xl border border-red-200 bg-red-50 px-4 py-3 text-sm text-red-800",children:A}),l("div",{className:"mb-6 p-3 sm:p-4 bg-gradient-to-r from-blue-50 to-indigo-50 rounded-xl border border-blue-100",children:[l("div",{className:"flex items-start justify-between gap-4 mb-3",children:[i("div",{className:"flex items-center gap-2",children:l("div",{children:[l("div",{className:"flex items-center gap-2",children:[i("h3",{className:"text-sm font-semibold text-gray-900",children:"Bulk Actions"}),i(h,{content:"Quickly approve or reject all pending dispatch requests at once."})]}),l("p",{className:"text-xs text-gray-600",children:[ae.filter(e=>"dispatch_requested"===e.status).length," pending requests available"]})]})}),i(p,{isLoading:F,onClick:async()=>{W(!0);try{await K()}finally{W(!1)}}})]}),l("div",{className:"grid grid-cols-1 sm:grid-cols-2 gap-2 sm:gap-3",children:[i("button",{onClick:()=>re("approved"),disabled:H||0===ae.filter(e=>"dispatch_requested"===e.status).length,className:"px-3 sm:px-4 py-2 rounded-lg font-medium text-white text-xs sm:text-sm transition-all duration-200 shadow-sm hover:shadow focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-1 "+(H||0===ae.filter(e=>"dispatch_requested"===e.status).length?"bg-gray-300 cursor-not-allowed":"bg-green-600 hover:bg-green-700"),children:l("span",{className:"flex items-center justify-center gap-1",children:[i("span",{children:"âœ…"}),i("span",{children:H?"Processing...":"Approve All"})]})}),i("button",{onClick:()=>re("rejected"),disabled:H||0===ae.filter(e=>"dispatch_requested"===e.status).length,className:"px-3 sm:px-4 py-2 rounded-lg font-medium text-white text-xs sm:text-sm transition-all duration-200 shadow-sm hover:shadow focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-1 "+(H||0===ae.filter(e=>"dispatch_requested"===e.status).length?"bg-gray-300 cursor-not-allowed":"bg-red-600 hover:bg-red-700"),children:l("span",{className:"flex items-center justify-center gap-1",children:[i("span",{children:"â›”"}),i("span",{children:H?"Processing...":"Reject All"})]})})]})]}),i("div",{className:"space-y-4",children:ae.map(e=>i(d,{actions:[{label:"Details",icon:"ðŸ‘ï¸",className:"border-slate-300 text-slate-600 hover:border-slate-500 hover:bg-slate-50",onClick:()=>z(`/marksheets/${e._id||e.marksheetId}`)},{label:"Reject",icon:"âŒ",className:"border-red-300 text-red-600 hover:border-red-500 hover:bg-red-50",onClick:t=>ee(t,e,"rejected")},{label:"Approve",icon:"âœ…",className:"border-green-300 text-green-600 hover:border-green-500 hover:bg-green-50",onClick:t=>ee(t,e,"approved")}],children:l("div",{className:"bg-white",children:[l("div",{className:"p-4 sm:p-6 pb-3 sm:pb-4",children:[l("div",{className:"flex items-start justify-between mb-3 gap-2",children:[l("div",{className:"flex-1 min-w-0",children:[i("h3",{className:"text-lg sm:text-xl font-bold text-gray-900 mb-1 truncate",children:e.studentDetails?.name}),l("p",{className:"text-xs sm:text-sm text-gray-600 flex items-center gap-2",children:[l("span",{children:[e.studentDetails?.regNumber," â€¢ ",le(e.studentDetails)]}),e.studentDetails?.department&&i("span",{className:`inline-flex items-center gap-1 rounded-full px-2 py-0.5 text-[10px] font-semibold uppercase ${O[e.studentDetails.department]||"bg-gray-100 text-gray-800"}`,children:B[e.studentDetails?.department]||(e.studentDetails?.department||"").toUpperCase()})]})]}),l("span",{className:`px-2 py-1 sm:px-3 sm:py-1.5 rounded-full text-xs font-semibold uppercase tracking-wide flex items-center gap-1 whitespace-nowrap ${ne[e.status]||"bg-yellow-100 text-yellow-800"}`,children:[i("span",{className:"text-xs sm:text-sm",children:ie[e.status]||"ðŸ“„"}),i("span",{className:"text-xs",children:(e.status||"").replace(/_/g," ")})]})]}),l("div",{className:"grid grid-cols-2 lg:grid-cols-4 gap-3 sm:gap-4 md:gap-6 text-xs sm:text-sm",children:[l("div",{children:[i("p",{className:"text-gray-500 mb-1",children:"Staff:"}),i("p",{className:"font-medium text-gray-900 truncate",children:e.staffName||"demo staff"})]}),l("div",{children:[i("p",{className:"text-gray-500 mb-1",children:"Parent Phone:"}),i("p",{className:"font-medium text-gray-900",children:e.studentDetails?.parentPhoneNumber||"â€”"})]}),l("div",{children:[i("p",{className:"text-gray-500 mb-1",children:"Exam Date:"}),i("p",{className:"font-medium text-gray-900",children:e.examinationDate?new Date(e.examinationDate).toLocaleDateString("en-US",{month:"short",year:"numeric"}):"â€”"})]}),l("div",{children:[i("p",{className:"text-gray-500 mb-1",children:"Subjects:"}),i("p",{className:"font-medium text-gray-900",children:e.subjects?.length||0})]})]})]}),i("div",{className:"border-t border-gray-100"}),i("div",{className:"hidden sm:block p-4 sm:p-6 pt-3 sm:pt-4 bg-gray-50",children:l("div",{className:"grid grid-cols-4 gap-3",children:[i("button",{onClick:t=>ee(t,e,"approved"),className:"px-4 py-2.5 bg-green-600 hover:bg-green-700 text-white text-sm font-medium rounded-lg transition-all duration-200 shadow-sm hover:shadow focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-1",children:"Approve Dispatch"}),i("button",{onClick:t=>ee(t,e,"rejected"),className:"px-4 py-2.5 bg-red-600 hover:bg-red-700 text-white text-sm font-medium rounded-lg transition-all duration-200 shadow-sm hover:shadow focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-1",children:"Reject Request"}),i("button",{onClick:()=>z(`/marksheets/${e._id||e.marksheetId}`),className:"px-4 py-2.5 bg-white hover:bg-gray-50 text-gray-700 text-sm font-medium rounded-lg border border-gray-300 transition-all duration-200 shadow-sm hover:shadow focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-1",children:"View Details"})]})}),i("div",{className:"sm:hidden p-3 bg-gradient-to-r from-blue-50 to-indigo-50 border-t border-blue-100",children:l("p",{className:"text-xs text-center text-gray-600 flex items-center justify-center gap-2",children:[i("span",{children:"ðŸ‘ˆ"}),i("span",{className:"font-medium",children:"Swipe left for actions"})]})})]})},e._id))})]})})]})}),i(t,{open:_.open,type:_.type,marksheet:_.marksheet,anchorRect:_.anchorRect,onClose:te,onSubmit:async({comments:t})=>{if(_.marksheet&&_.type)try{$(!0);const r=await Z();if(!r?.eSignature)return x("Signature Missing","Please add your signature in Settings before approving requests"),void $(!1);const s=w._id||w.id,a=await n.post("/api/marksheets?action=hod-response",{marksheetId:_.marksheet._id,hodId:s,response:_.type,comments:t});if(!a||!a.success)throw new Error(a?.error||"Failed to submit response");const i="approved"===_.type?"approved":"rejected",l=_.marksheet?.studentDetails?.name||"Student";L(`Dispatch request ${i} successfully.`),"approved"===_.type?e("âœ“ Approved",`Dispatch approved for ${l}`):b("Request Rejected",`Dispatch rejected for ${l}`),te(),await K()}catch(r){I(r.message||"Unexpected error"),x("Action Failed",r.message||"Could not process the request")}finally{$(!1)}},loading:R,error:A}),i(v,{})]}):i("div",{className:"min-h-screen bg-gradient-to-br from-slate-50 via-blue-50 to-indigo-50 flex items-center justify-center",children:l("div",{className:"glass-card p-8 rounded-3xl text-center",children:[i("h1",{className:"text-2xl font-bold text-gray-900 mb-4",children:"Access Denied"}),i("p",{className:"text-gray-600",children:"Only HODs can approve dispatch requests."})]})})})}}});
