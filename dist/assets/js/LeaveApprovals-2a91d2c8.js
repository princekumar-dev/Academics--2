import{j as i,u as N,b as o,a as x,_ as q}from"./index-35ab9bf4.js";import{N as A,r as p}from"./react-vendor-ad4d5528.js";import{u as D}from"./usePullToRefresh-f728b668.js";function R(){const m=localStorage.getItem("auth"),d=m?JSON.parse(m):null;if(!d||d.role!=="hod")return i(A,{to:"/home",replace:!0});const{showSuccess:c,showError:n}=N(),[v,y]=p.useState([]),[u,f]=p.useState(!1),[h,b]=p.useState(null),l=async()=>{var e;try{f(!0);const r=new URLSearchParams({department:d.department,type:"leave",status:"requested"});console.log("[LeaveApprovals] Fetching with:",{department:d.department,type:"leave",status:"requested"});const t=await x.get("/api/leaves?".concat(r.toString()));return console.log("[LeaveApprovals] Response:",t),t.success?(y(t.requests||[]),b({filter:t.filter,count:((e=t.requests)==null?void 0:e.length)||0,hodDept:d.department}),t):(n("Failed to load",t.error||"Could not fetch requests"),t)}catch(r){console.error("[LeaveApprovals] Error:",r),n("Error",r.message)}finally{f(!1)}};p.useEffect(()=>{l()},[]),D(l),p.useEffect(()=>{const e=()=>l();return window.addEventListener("notificationsUpdated",e),window.addEventListener("marksheetsUpdated",e),()=>{window.removeEventListener("notificationsUpdated",e),window.removeEventListener("marksheetsUpdated",e)}},[]);const g=async(e,r)=>{try{const t=r==="approve"?{timeout:12e4}:{},a=await x.patch("/api/leaves?id=".concat(e,"&action=").concat(r),{hodId:d.id},Object.assign({},t,{dispatch:!1}));if(a&&a.success){if(r==="approve"&&a.whatsappResult){const s=a.whatsappResult;s.sentPdf?c("Approved & Sent","Leave letter PDF sent via WhatsApp"):s.sentText?(c("Approved (text sent)","Approval text sent but PDF failed to send"),s.errors&&s.errors.length&&n("PDF send failed",s.errors[0])):(c("Approved","Request approved"),s.errors&&s.errors.length&&n("WhatsApp failed",s.errors[0]))}else c(r==="approve"?"Approved":"Rejected","Request updated");try{q(()=>import("./notificationEvents-12cfbdaf.js"),[]).then(s=>s.notifyNotificationsUpdated())}catch(s){try{window.dispatchEvent(new Event("notificationsUpdated"))}catch(w){}}try{window.refreshNotificationCount&&window.refreshNotificationCount()}catch(s){}l()}else n("Failed",(a==null?void 0:a.error)||"Could not update request")}catch(t){if(t&&(t.name==="AbortError"||String(t).includes("signal is aborted")||String(t).includes("timeout")))try{const a=await l();a&&a.requests&&a.requests.find(w=>w._id===e)?n("Timeout","Server took too long to respond. The approval may not have completed — check request status."):c("Approved","Request approved (server-side) — refreshed list updated")}catch(a){n("Timeout","Server took too long to respond. The approval may have completed — check request status.")}else n("Error",t.message)}};return o("div",{className:"px-4 py-4 w-full max-w-4xl mx-auto",children:[o("div",{className:"flex items-center justify-between mb-4",children:[i("h1",{className:"text-2xl font-bold",children:"Leave Approvals"}),i("button",{onClick:l,className:"px-3 py-2 text-sm rounded-lg border bg-white hover:bg-gray-50",disabled:u,children:u?"Loading...":"Refresh"})]}),h&&o("div",{className:"mb-4 p-3 bg-blue-50 rounded-lg text-xs",children:[o("div",{children:["HOD Dept: ",h.hodDept]}),o("div",{children:["Found: ",h.count," requests"]})]}),u?i("div",{className:"p-4 text-gray-500",children:"Loading..."}):o("ul",{className:"divide-y bg-white rounded-xl shadow",children:[v.map(e=>{var r,t;return o("li",{className:"p-4 flex items-center justify-between",children:[o("div",{children:[o("div",{className:"font-medium",children:[(r=e.studentDetails)==null?void 0:r.name," (",(t=e.studentDetails)==null?void 0:t.regNumber,")"]}),o("div",{className:"text-sm text-gray-600",children:[new Date(e.startDate).toLocaleDateString()," → ",new Date(e.endDate).toLocaleDateString()]}),o("div",{className:"text-sm text-gray-600",children:["Reason: ",e.reason]})]}),o("div",{className:"flex gap-2",children:[i("button",{onClick:()=>g(e._id,"approve"),className:"px-3 py-2 text-sm rounded-lg bg-green-600 text-white",children:"Approve"}),i("button",{onClick:()=>g(e._id,"reject"),className:"px-3 py-2 text-sm rounded-lg bg-red-600 text-white",children:"Reject"})]})]},e._id)}),v.length===0&&i("li",{className:"p-4 text-gray-500",children:"No pending requests."})]})]})}export{R as default};
